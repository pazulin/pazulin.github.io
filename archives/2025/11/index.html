<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>Archives: 2025/11 | 逍遥游</title>
  
  

  

  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.6.3/css/all.min.css">
  

  

  
    
<link rel="stylesheet" href="/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  
  
  <div class="cover-wrapper">
    <cover class='cover  half'>
      
        
  <h1 class='title'>逍遥游</h1>


  <div class="m_search">
    <form name="searchform" class="form u-search-form">
      <input type="text" class="input u-search-input" placeholder="" />
      <i class="icon fas fa-search fa-fw"></i>
    </form>
  </div>

<div class='menu navgation'>
  <ul class='h-list'>
    
      
        <li>
          <a class="nav home" href="/"
            
            
            id="home">
            <i class='fas fa-rss fa-fw'></i>&nbsp;文章
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/projects/"
            
            
            id="projects">
            <i class='fas fa-code-branch fa-fw'></i>&nbsp;项目
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/about/"
            
              rel="nofollow"
            
            
            id="about">
            <i class='fas fa-info-circle fa-fw'></i>&nbsp;关于
          </a>
        </li>
      
    
  </ul>
</div>

      
    </cover>
    <header class="l_header material">
  <div id="loading-bar-wrapper">
    <div id="loading-bar" class="material"></div>
  </div>

	<div class='wrapper'>
		<div class="nav-main container container--flex">
      <a class="logo flat-box" href='/' >
        
          逍遥游
        
      </a>
			<div class='menu navgation'>
				<ul class='h-list'>
          
  					
  						<li>
								<a class="nav flat-box" href="/"
                  
                  
                  id="home">
									<i class='fas fa-grin fa-fw'></i>&nbsp;示例
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/categories/"
                  
                    rel="nofollow"
                  
                  
                  id="categories">
									<i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/tags/"
                  
                    rel="nofollow"
                  
                  
                  id="tags">
									<i class='fas fa-hashtag fa-fw'></i>&nbsp;标签
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/archives/"
                  
                    rel="nofollow"
                  
                  
                  id="archives">
									<i class='fas fa-archive fa-fw'></i>&nbsp;归档
								</a>
							</li>
      			
      		
				</ul>
			</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="搜尋" />
						<i class="icon fas fa-search fa-fw"></i>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a class="fas fa-search fa-fw" href='javascript:void(0)'></a></li>
				
				<li class='s-menu'><a class="fas fa-bars fa-fw" href='javascript:void(0)'></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo flat-box"></a>
			<ul class='switcher h-list'>
				<li class='s-comment'><a class="flat-btn fas fa-comments fa-fw" href='javascript:void(0)'></a></li>
        
          <li class='s-toc'><a class="flat-btn fas fa-list fa-fw" href='javascript:void(0)'></a></li>
        
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
    <header>
		<nav class="menu navgation">
      <ul>
        
          
            <li>
							<a class="nav flat-box" href="/"
                
                
                id="home">
								<i class='fas fa-clock fa-fw'></i>&nbsp;近期文章
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/archives/"
                
                  rel="nofollow"
                
                
                id="archives">
								<i class='fas fa-archive fa-fw'></i>&nbsp;文章归档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/projects/"
                
                
                id="projects">
								<i class='fas fa-code-branch fa-fw'></i>&nbsp;开源项目
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/about/"
                
                  rel="nofollow"
                
                
                id="about">
								<i class='fas fa-info-circle fa-fw'></i>&nbsp;关于小站
							</a>
            </li>
          
       
      </ul>
		</nav>
    </header>
	</aside>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      <div class='l_main'>
	
		
  <section class="post-list">
    
      
        
          
        
      
    
    
      
        
          <div class='post-wrapper'>
            <article class="post reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2025/11/01/volumio-display-key/">
      volumio增加外置显示屏和按键
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    <a href="https://pazulin.github.io" rel="nofollow">
      
        <i class="fas fa-user" aria-hidden="true"></i>
      
      <p>井蛙</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2025-11-01</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/linux/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>linux</p>
    </a>
  </div>


          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <p>Q7上面跑volumio 2.8,增加一个ESP32C3 的模块, 这个模块有显示屏和按键,显示屏接的是1.3寸OLED 显示屏, 按键接的是一个4个按键的模块,分别接到ESP32C3的GPIO</p>
<p>python 代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">import serial</span><br><span class="line">import time</span><br><span class="line">import json</span><br><span class="line">import requests</span><br><span class="line">import logging</span><br><span class="line">from threading import Thread</span><br><span class="line">from Queue import Queue</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line"># 重新加载sys并设置默认编码</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(&#x27;utf-8&#x27;)</span><br><span class="line"></span><br><span class="line"># 配置日志 - 抑制 requests 和 urllib3 的日志</span><br><span class="line">logging.basicConfig(level=logging.INFO, format=&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;)</span><br><span class="line">logging.getLogger(&quot;requests&quot;).setLevel(logging.WARNING)</span><br><span class="line">logging.getLogger(&quot;urllib3&quot;).setLevel(logging.WARNING)</span><br><span class="line"></span><br><span class="line">SERIAL_PORT = &#x27;/dev/ttyACM0&#x27;</span><br><span class="line">BAUD_RATE = 115200</span><br><span class="line">VOLUMIO_HOST = &#x27;localhost&#x27;</span><br><span class="line">VOLUMIO_PORT = 3000</span><br><span class="line"></span><br><span class="line">GET_STATE = &#x27;http://&#123;&#125;:&#123;&#125;/api/v1/getState&#x27;.format(VOLUMIO_HOST, VOLUMIO_PORT)</span><br><span class="line">GET_QUEUE = &#x27;http://&#123;&#125;:&#123;&#125;/api/v1/getQueue&#x27;.format(VOLUMIO_HOST, VOLUMIO_PORT)</span><br><span class="line"></span><br><span class="line">SEEK_UPDATE_INTERVAL = 2</span><br><span class="line">MAX_RETRIES = 3</span><br><span class="line">RETRY_DELAY = 5</span><br><span class="line"></span><br><span class="line"># 创建会话对象，支持连接复用</span><br><span class="line">session = requests.Session()</span><br><span class="line"></span><br><span class="line">class VolumioController:</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.ser = None</span><br><span class="line">        self.command_queue = Queue()</span><br><span class="line">        self.running = True</span><br><span class="line">        self.volumio_available = True</span><br><span class="line">        self.serial_available = False</span><br><span class="line">        self.last_state_data = None</span><br><span class="line">        self.last_queue_data = None</span><br><span class="line">        self.data_cache_time = 0</span><br><span class="line">        self.queue_cache_time = 0</span><br><span class="line">        self.last_position = -1  # 记录上次的位置</span><br><span class="line">        self.last_uri = &quot;&quot;  # 记录上次的URI，用于检测文件夹切换</span><br><span class="line">        self.cache_duration = 1.0  # 状态缓存1秒</span><br><span class="line">        self.queue_cache_duration = 2.0  # 队列缓存2秒，减少时间</span><br><span class="line">        </span><br><span class="line">    def init_serial(self):</span><br><span class="line">        &quot;&quot;&quot;初始化串口连接，支持重试&quot;&quot;&quot;</span><br><span class="line">        retry_count = 0</span><br><span class="line">        while retry_count &lt; MAX_RETRIES and self.running:</span><br><span class="line">            try:</span><br><span class="line">                self.ser = serial.Serial(SERIAL_PORT, BAUD_RATE, timeout=0.5)</span><br><span class="line">                self.serial_available = True</span><br><span class="line">                logging.info(&quot;串口连接成功: %s&quot;, SERIAL_PORT)</span><br><span class="line">                return True</span><br><span class="line">            except Exception as e:</span><br><span class="line">                retry_count += 1</span><br><span class="line">                logging.error(&quot;串口连接失败 (尝试 %d/%d): %s&quot;, retry_count, MAX_RETRIES, str(e))</span><br><span class="line">                if retry_count &lt; MAX_RETRIES:</span><br><span class="line">                    time.sleep(RETRY_DELAY)</span><br><span class="line">        </span><br><span class="line">        logging.error(&quot;无法建立串口连接，程序退出&quot;)</span><br><span class="line">        return False</span><br><span class="line"></span><br><span class="line">    # def truncate_song_name(self, name, max_length=10):</span><br><span class="line">    #     &quot;&quot;&quot;截断歌曲名称，直接截取前max_length个字符&quot;&quot;&quot;</span><br><span class="line">    #     if not name:</span><br><span class="line">    #         return u&quot;未知歌曲&quot;</span><br><span class="line">        </span><br><span class="line">    #     # 确保是unicode字符串</span><br><span class="line">    #     if not isinstance(name, unicode):</span><br><span class="line">    #         try:</span><br><span class="line">    #             name = name.decode(&#x27;utf-8&#x27;)</span><br><span class="line">    #         except:</span><br><span class="line">    #             name = u&quot;未知歌曲&quot;</span><br><span class="line">        </span><br><span class="line">    #     if len(name) &lt;= max_length:</span><br><span class="line">    #         return name</span><br><span class="line">        </span><br><span class="line">    #     # 直接截取前max_length个字符，不加省略号</span><br><span class="line">    #     return name[:max_length]</span><br><span class="line">    def truncate_song_name(self, name, max_chinese=10, max_english=20):</span><br><span class="line">        &quot;&quot;&quot;截断歌曲名称，如果包含中文就用10个字符，否则用20个字符&quot;&quot;&quot;</span><br><span class="line">        if not name:</span><br><span class="line">            return u&quot;未知歌曲&quot;</span><br><span class="line">        </span><br><span class="line">        # 确保是unicode字符串</span><br><span class="line">        if not isinstance(name, unicode):</span><br><span class="line">            try:</span><br><span class="line">                name = name.decode(&#x27;utf-8&#x27;)</span><br><span class="line">            except:</span><br><span class="line">                return u&quot;未知歌曲&quot;</span><br><span class="line">        </span><br><span class="line">        # 检查是否包含中文字符</span><br><span class="line">        has_chinese = any(u&#x27;\u4e00&#x27; &lt;= char &lt;= u&#x27;\u9fff&#x27; for char in name)</span><br><span class="line">        </span><br><span class="line">        # 选择最大长度</span><br><span class="line">        max_length = max_chinese if has_chinese else max_english</span><br><span class="line">        </span><br><span class="line">        if len(name) &lt;= max_length:</span><br><span class="line">            return name</span><br><span class="line">        </span><br><span class="line">        return name[:max_length]</span><br><span class="line">        </span><br><span class="line">    def safe_volumio_request(self, url, timeout=2, use_cache=False, cache_type=&quot;state&quot;):</span><br><span class="line">        &quot;&quot;&quot;安全的Volumio请求，带重试机制和缓存&quot;&quot;&quot;</span><br><span class="line">        current_time = time.time()</span><br><span class="line">        </span><br><span class="line">        # 使用缓存数据（如果可用且未过期）</span><br><span class="line">        if use_cache:</span><br><span class="line">            cache_duration = self.cache_duration if cache_type == &quot;state&quot; else self.queue_cache_duration</span><br><span class="line">            cache_time = self.data_cache_time if cache_type == &quot;state&quot; else self.queue_cache_time</span><br><span class="line">            cache_data = self.last_state_data if cache_type == &quot;state&quot; else self.last_queue_data</span><br><span class="line">            </span><br><span class="line">            if cache_data and current_time - cache_time &lt; cache_duration:</span><br><span class="line">                if url == GET_STATE and cache_type == &quot;state&quot;:</span><br><span class="line">                    return self.last_state_data</span><br><span class="line">                elif url == GET_QUEUE and cache_type == &quot;queue&quot;:</span><br><span class="line">                    return self.last_queue_data</span><br><span class="line">        </span><br><span class="line">        for attempt in range(MAX_RETRIES):</span><br><span class="line">            try:</span><br><span class="line">                response = session.get(url, timeout=timeout)</span><br><span class="line">                if response.status_code == 200:</span><br><span class="line">                    self.volumio_available = True</span><br><span class="line">                    data = response.json()</span><br><span class="line">                    </span><br><span class="line">                    # 缓存数据</span><br><span class="line">                    if url == GET_STATE:</span><br><span class="line">                        self.last_state_data = data</span><br><span class="line">                        self.data_cache_time = current_time</span><br><span class="line">                    elif url == GET_QUEUE:</span><br><span class="line">                        self.last_queue_data = data</span><br><span class="line">                        self.queue_cache_time = current_time</span><br><span class="line">                    </span><br><span class="line">                    return data</span><br><span class="line">                else:</span><br><span class="line">                    logging.warning(&quot;Volumio返回错误状态码: %d&quot;, response.status_code)</span><br><span class="line">            except Exception as e:</span><br><span class="line">                logging.warning(&quot;Volumio请求失败 (尝试 %d/%d): %s&quot;, attempt + 1, MAX_RETRIES, str(e))</span><br><span class="line">            </span><br><span class="line">            if attempt &lt; MAX_RETRIES - 1:</span><br><span class="line">                time.sleep(1)</span><br><span class="line">        </span><br><span class="line">        self.volumio_available = False</span><br><span class="line">        logging.error(&quot;Volumio服务不可用&quot;)</span><br><span class="line">        return None</span><br><span class="line"></span><br><span class="line">    def get_volumio_status(self):</span><br><span class="line">        &quot;&quot;&quot;获取Volumio状态，带降级处理&quot;&quot;&quot;</span><br><span class="line">        state_data = self.safe_volumio_request(GET_STATE, use_cache=True, cache_type=&quot;state&quot;)</span><br><span class="line">        if not state_data:</span><br><span class="line">            return self.get_fallback_status()</span><br><span class="line">        </span><br><span class="line">        try:</span><br><span class="line">            # 修正字段映射</span><br><span class="line">            seek_ms = state_data.get(&#x27;seek&#x27;, 0)  # 毫秒</span><br><span class="line">            seek = int(seek_ms / 1000)  # 转换为秒</span><br><span class="line">            duration = int(state_data.get(&#x27;duration&#x27;, 1) or 1)</span><br><span class="line">            title = state_data.get(&#x27;title&#x27;, u&#x27;无歌曲&#x27;)</span><br><span class="line">            status = state_data.get(&#x27;status&#x27;, &#x27;stop&#x27;)</span><br><span class="line">            current_position = int(state_data.get(&#x27;position&#x27;, -1))  # 队列中的位置</span><br><span class="line">            current_uri = state_data.get(&#x27;uri&#x27;, &#x27;&#x27;)  # 当前歌曲的URI</span><br><span class="line"></span><br><span class="line">            # 检测文件夹切换 - 如果URI路径发生变化，强制刷新队列</span><br><span class="line">            force_queue_update = False</span><br><span class="line">            if current_uri and self.last_uri:</span><br><span class="line">                # 提取文件夹路径进行比较</span><br><span class="line">                current_folder = &#x27;/&#x27;.join(current_uri.split(&#x27;/&#x27;)[:-1])</span><br><span class="line">                last_folder = &#x27;/&#x27;.join(self.last_uri.split(&#x27;/&#x27;)[:-1])</span><br><span class="line">                if current_folder != last_folder:</span><br><span class="line">                    logging.info(&quot;检测到文件夹切换，强制刷新队列&quot;)</span><br><span class="line">                    force_queue_update = True</span><br><span class="line">            </span><br><span class="line">            self.last_uri = current_uri</span><br><span class="line"></span><br><span class="line">            # 简化歌曲名称显示 - 当前歌曲保留完整名称</span><br><span class="line">            display_title = self.truncate_song_name(title, 30)  # 当前歌曲显示30个字符</span><br><span class="line"></span><br><span class="line">            # 只有当需要时才获取队列信息</span><br><span class="line">            prev_song = u&#x27;无&#x27;</span><br><span class="line">            next_song = u&#x27;无&#x27;</span><br><span class="line">            if status == &#x27;play&#x27; or status == &#x27;pause&#x27;:</span><br><span class="line">                # 检查位置是否改变或需要强制更新</span><br><span class="line">                position_changed = (current_position != self.last_position)</span><br><span class="line">                if position_changed or force_queue_update:</span><br><span class="line">                    logging.info(&quot;位置变化或强制更新，重新获取队列信息&quot;)</span><br><span class="line">                </span><br><span class="line">                prev_song, next_song = self.get_queue_info(</span><br><span class="line">                    current_position, </span><br><span class="line">                    force_update=(position_changed or force_queue_update)</span><br><span class="line">                )</span><br><span class="line">                self.last_position = current_position</span><br><span class="line">            </span><br><span class="line">            return &#123;</span><br><span class="line">                &quot;title&quot;: display_title,</span><br><span class="line">                &quot;prevSong&quot;: prev_song,</span><br><span class="line">                &quot;nextSong&quot;: next_song,</span><br><span class="line">                &quot;duration&quot;: duration,</span><br><span class="line">                &quot;seek&quot;: seek,</span><br><span class="line">                &quot;status&quot;: status</span><br><span class="line">            &#125;</span><br><span class="line">        except Exception as e:</span><br><span class="line">            logging.error(&quot;解析Volumio状态数据失败: %s, 原始数据: %s&quot;, str(e), state_data)</span><br><span class="line">            return self.get_fallback_status()</span><br><span class="line"></span><br><span class="line">    def get_queue_info(self, position, force_update=False):</span><br><span class="line">        &quot;&quot;&quot;获取队列信息&quot;&quot;&quot;</span><br><span class="line">        # 修正：只有当位置有效时才获取队列</span><br><span class="line">        if position &lt; 0:</span><br><span class="line">            return u&#x27;无&#x27;, u&#x27;无&#x27;</span><br><span class="line">            </span><br><span class="line">        # 如果强制更新，不使用缓存</span><br><span class="line">        use_cache = not force_update</span><br><span class="line">        queue_data = self.safe_volumio_request(GET_QUEUE, use_cache=use_cache, cache_type=&quot;queue&quot;)</span><br><span class="line">        if not queue_data:</span><br><span class="line">            return u&#x27;未知&#x27;, u&#x27;未知&#x27;</span><br><span class="line">        </span><br><span class="line">        try:</span><br><span class="line">            queue = queue_data.get(&#x27;queue&#x27;, [])</span><br><span class="line">            prev_song = u&#x27;无&#x27;</span><br><span class="line">            next_song = u&#x27;无&#x27;</span><br><span class="line">            </span><br><span class="line">            if 0 &lt;= position &lt; len(queue):</span><br><span class="line">                if position &gt; 0:</span><br><span class="line">                    prev_item = queue[position - 1]</span><br><span class="line">                    # 尝试多个可能的字段名</span><br><span class="line">                    prev_name = prev_item.get(&#x27;name&#x27;, prev_item.get(&#x27;title&#x27;, u&#x27;无&#x27;))</span><br><span class="line">                    # 队列中的歌曲名称截取前10个字符</span><br><span class="line">                    prev_song = self.truncate_song_name(prev_name, 10)</span><br><span class="line">                </span><br><span class="line">                if position &lt; len(queue) - 1:</span><br><span class="line">                    next_item = queue[position + 1]</span><br><span class="line">                    # 尝试多个可能的字段名</span><br><span class="line">                    next_name = next_item.get(&#x27;name&#x27;, next_item.get(&#x27;title&#x27;, u&#x27;无&#x27;))</span><br><span class="line">                    # 队列中的歌曲名称截取前10个字符</span><br><span class="line">                    next_song = self.truncate_song_name(next_name, 10)</span><br><span class="line">            </span><br><span class="line">            logging.debug(&quot;队列信息: 位置=%d, 上一首=%s, 下一首=%s&quot;, position, prev_song, next_song)</span><br><span class="line">            return prev_song, next_song</span><br><span class="line">        except Exception as e:</span><br><span class="line">            logging.error(&quot;解析队列信息失败: %s, 队列数据: %s&quot;, str(e), queue_data)</span><br><span class="line">            return u&#x27;未知&#x27;, u&#x27;未知&#x27;</span><br><span class="line"></span><br><span class="line">    def get_fallback_status(self):</span><br><span class="line">        &quot;&quot;&quot;返回降级状态&quot;&quot;&quot;</span><br><span class="line">        return &#123;</span><br><span class="line">            &quot;title&quot;: u&quot;服务不可用&quot;,</span><br><span class="line">            &quot;prevSong&quot;: u&quot;未知&quot;,</span><br><span class="line">            &quot;nextSong&quot;: u&quot;未知&quot;,</span><br><span class="line">            &quot;duration&quot;: 1,</span><br><span class="line">            &quot;seek&quot;: 0,</span><br><span class="line">            &quot;status&quot;: &quot;stop&quot;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    def safe_serial_send(self, data):</span><br><span class="line">        &quot;&quot;&quot;安全的串口数据发送&quot;&quot;&quot;</span><br><span class="line">        if not self.serial_available or not self.ser:</span><br><span class="line">            return False</span><br><span class="line">        </span><br><span class="line">        try:</span><br><span class="line">            # 确保所有字符串都是UTF-8编码的普通字符串，而不是Unicode对象</span><br><span class="line">            ascii_safe_data = &#123;&#125;</span><br><span class="line">            for key, value in data.items():</span><br><span class="line">                if isinstance(value, unicode):</span><br><span class="line">                    # 将Unicode转换为UTF-8编码的字符串</span><br><span class="line">                    ascii_safe_data[key] = value.encode(&#x27;utf-8&#x27;)</span><br><span class="line">                else:</span><br><span class="line">                    ascii_safe_data[key] = value</span><br><span class="line">            </span><br><span class="line">            # 使用 ensure_ascii=False 来支持中文</span><br><span class="line">            json_str = json.dumps(ascii_safe_data, ensure_ascii=False) + &#x27;\n&#x27;</span><br><span class="line">            </span><br><span class="line">            # 在 Python 2.7 中，需要显式编码为 UTF-8</span><br><span class="line">            self.ser.write(json_str.encode(&#x27;utf-8&#x27;))</span><br><span class="line">            return True</span><br><span class="line">        except Exception as e:</span><br><span class="line">            logging.error(&quot;串口发送失败: %s&quot;, str(e))</span><br><span class="line">            self.serial_available = False</span><br><span class="line">            self.try_reconnect_serial()</span><br><span class="line">            return False</span><br><span class="line"></span><br><span class="line">    def try_reconnect_serial(self):</span><br><span class="line">        &quot;&quot;&quot;尝试重新连接串口&quot;&quot;&quot;</span><br><span class="line">        if self.ser:</span><br><span class="line">            try:</span><br><span class="line">                self.ser.close()</span><br><span class="line">            except:</span><br><span class="line">                pass</span><br><span class="line">        </span><br><span class="line">        logging.info(&quot;尝试重新连接串口...&quot;)</span><br><span class="line">        self.serial_available = self.init_serial()</span><br><span class="line"></span><br><span class="line">    def handle_esp32_command(self, cmd):</span><br><span class="line">        &quot;&quot;&quot;处理ESP32命令&quot;&quot;&quot;</span><br><span class="line">        cmd = cmd.strip().upper()</span><br><span class="line">        command_urls = &#123;</span><br><span class="line">            &#x27;PLAY&#x27;: &#x27;http://&#123;&#125;:&#123;&#125;/api/v1/commands/?cmd=play&#x27;.format(VOLUMIO_HOST, VOLUMIO_PORT),</span><br><span class="line">            &#x27;PAUSE&#x27;: &#x27;http://&#123;&#125;:&#123;&#125;/api/v1/commands/?cmd=pause&#x27;.format(VOLUMIO_HOST, VOLUMIO_PORT),</span><br><span class="line">            &#x27;NEXT&#x27;: &#x27;http://&#123;&#125;:&#123;&#125;/api/v1/commands/?cmd=next&#x27;.format(VOLUMIO_HOST, VOLUMIO_PORT),</span><br><span class="line">            &#x27;PREV&#x27;: &#x27;http://&#123;&#125;:&#123;&#125;/api/v1/commands/?cmd=prev&#x27;.format(VOLUMIO_HOST, VOLUMIO_PORT)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if cmd in command_urls:</span><br><span class="line">            # 执行命令后，强制更新队列信息</span><br><span class="line">            self.safe_volumio_request(command_urls[cmd], timeout=1)</span><br><span class="line">            # 清除队列缓存，确保下次获取最新数据</span><br><span class="line">            self.last_queue_data = None</span><br><span class="line">            self.queue_cache_time = 0</span><br><span class="line">            # 重置位置跟踪</span><br><span class="line">            self.last_position = -1</span><br><span class="line">        else:</span><br><span class="line">            logging.warning(&quot;未知命令: %s&quot;, cmd)</span><br><span class="line"></span><br><span class="line">    def read_serial_commands(self):</span><br><span class="line">        &quot;&quot;&quot;读取串口命令的独立线程&quot;&quot;&quot;</span><br><span class="line">        while self.running:</span><br><span class="line">            if self.serial_available and self.ser and self.ser.inWaiting():</span><br><span class="line">                try:</span><br><span class="line">                    line = self.ser.readline().strip()</span><br><span class="line">                    if line:</span><br><span class="line">                        # Python 2.7 解码处理</span><br><span class="line">                        try:</span><br><span class="line">                            line = line.decode(&#x27;utf-8&#x27;)</span><br><span class="line">                        except UnicodeDecodeError:</span><br><span class="line">                            try:</span><br><span class="line">                                line = line.decode(&#x27;gbk&#x27;)</span><br><span class="line">                            except:</span><br><span class="line">                                line = line.decode(&#x27;latin-1&#x27;)</span><br><span class="line">                        </span><br><span class="line">                        logging.info(&quot;收到ESP32命令: %s&quot;, line)</span><br><span class="line">                        self.handle_esp32_command(line)</span><br><span class="line">                except Exception as e:</span><br><span class="line">                    logging.error(&quot;串口读取错误: %s&quot;, str(e))</span><br><span class="line">                    self.serial_available = False</span><br><span class="line">            time.sleep(0.1)</span><br><span class="line"></span><br><span class="line">    def run(self):</span><br><span class="line">        &quot;&quot;&quot;主运行循环&quot;&quot;&quot;</span><br><span class="line">        if not self.init_serial():</span><br><span class="line">            return</span><br><span class="line">        </span><br><span class="line">        # 启动串口读取线程</span><br><span class="line">        serial_thread = Thread(target=self.read_serial_commands)</span><br><span class="line">        serial_thread.daemon = True</span><br><span class="line">        serial_thread.start()</span><br><span class="line">        </span><br><span class="line">        last_title = &quot;&quot;</span><br><span class="line">        last_status = &quot;&quot;</span><br><span class="line">        last_seek_sent = -1</span><br><span class="line">        last_seek_time = time.time()</span><br><span class="line">        last_health_check = time.time()</span><br><span class="line">        last_full_update = 0</span><br><span class="line">        </span><br><span class="line">        while self.running:</span><br><span class="line">            try:</span><br><span class="line">                current_time = time.time()</span><br><span class="line">                </span><br><span class="line">                # 健康检查（减少频率）</span><br><span class="line">                if current_time - last_health_check &gt; 30:</span><br><span class="line">                    if not self.volumio_available:</span><br><span class="line">                        logging.info(&quot;尝试恢复Volumio连接...&quot;)</span><br><span class="line">                        test_data = self.safe_volumio_request(GET_STATE, timeout=1)</span><br><span class="line">                        if test_data:</span><br><span class="line">                            logging.info(&quot;Volumio连接已恢复&quot;)</span><br><span class="line">                    last_health_check = current_time</span><br><span class="line">                </span><br><span class="line">                # 获取状态并发送</span><br><span class="line">                song_info = self.get_volumio_status()</span><br><span class="line">                </span><br><span class="line">                now = time.time()</span><br><span class="line">                # 减少完整状态发送频率</span><br><span class="line">                needs_full_update = (song_info[&#x27;title&#x27;] != last_title or </span><br><span class="line">                                   song_info[&#x27;status&#x27;] != last_status or</span><br><span class="line">                                   now - last_full_update &gt; 30)  # 每30秒强制更新一次</span><br><span class="line">                </span><br><span class="line">                if needs_full_update:</span><br><span class="line">                    if self.safe_serial_send(song_info):</span><br><span class="line">                        last_title = song_info[&#x27;title&#x27;]</span><br><span class="line">                        last_status = song_info[&#x27;status&#x27;]</span><br><span class="line">                        last_seek_sent = song_info[&#x27;seek&#x27;]</span><br><span class="line">                        last_seek_time = now</span><br><span class="line">                        last_full_update = now</span><br><span class="line">                # 如果正在播放且 seek 超过更新时间间隔 → 发送 seek 更新</span><br><span class="line">                elif (song_info[&#x27;status&#x27;] == &#x27;play&#x27; and </span><br><span class="line">                      (now - last_seek_time &gt;= SEEK_UPDATE_INTERVAL)):</span><br><span class="line">                    if song_info[&#x27;seek&#x27;] != last_seek_sent:</span><br><span class="line">                        if self.safe_serial_send(&#123;&quot;seek&quot;: song_info[&#x27;seek&#x27;]&#125;):</span><br><span class="line">                            last_seek_sent = song_info[&#x27;seek&#x27;]</span><br><span class="line">                    last_seek_time = now</span><br><span class="line">                </span><br><span class="line">                time.sleep(0.2)  # 增加休眠时间，减少请求频率</span><br><span class="line">                </span><br><span class="line">            except Exception as e:</span><br><span class="line">                logging.error(&quot;主循环发生未预期错误: %s&quot;, str(e))</span><br><span class="line">                time.sleep(1)</span><br><span class="line"></span><br><span class="line">    def stop(self):</span><br><span class="line">        &quot;&quot;&quot;停止运行&quot;&quot;&quot;</span><br><span class="line">        self.running = False</span><br><span class="line">        if self.ser:</span><br><span class="line">            try:</span><br><span class="line">                self.ser.close()</span><br><span class="line">            except:</span><br><span class="line">                pass</span><br><span class="line">        session.close()</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    controller = VolumioController()</span><br><span class="line">    try:</span><br><span class="line">        controller.run()</span><br><span class="line">    except KeyboardInterrupt:</span><br><span class="line">        logging.info(&quot;收到中断信号，程序退出&quot;)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        logging.error(&quot;程序运行出错: %s&quot;, str(e))</span><br><span class="line">    finally:</span><br><span class="line">        controller.stop()</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    main()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>把这个脚本加入系统服务<br>sudo nano &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;esp32_remote.service</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=ESP32 Volumio Remote Control Service</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=volumio</span><br><span class="line">WorkingDirectory=/home/volumio</span><br><span class="line">ExecStart=/usr/bin/python /home/volumio/remote_esp32.py</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>ESP32 那边代码如下,主要部分</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl start esp32_remote.service</span><br><span class="line">sudo systemctl status esp32_remote.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 初始化 SH1106，I2C 接口</span><br><span class="line">U8G2_SH1106_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0, /* reset=*/ U8X8_PIN_NONE, </span><br><span class="line">   /* SCL=*/ 5,  // 自定义 SCL 引脚</span><br><span class="line">  /* SDA=*/ 4   // 自定义 SDA 引脚</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 定义按键引脚</span><br><span class="line">#define BUTTON_PAUSE 8   // GPIO0 连接按键1（暂停）</span><br><span class="line">#define BUTTON_PLAY 20    // GPIO1 连接按键2（播放）</span><br><span class="line">#define BUTTON_NEXT 21    // GPIO2 连接按键3（下一首）</span><br><span class="line">#define BUTTON_PREV 1   // GPIO3 连接按键4（上一首）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#define BUTTON_SONG1 2   // GPIO4 连接按键5（歌曲1）</span><br><span class="line">#define BUTTON_SONG2 10   // GPIO5 连接按键6（歌曲2）</span><br><span class="line">#define BUTTON_SONG3 6   // GPIO6 连接按键7（歌曲3）</span><br><span class="line">#define BUTTON_SONG4 7   // GPIO7 连接按键8（歌曲4）</span><br><span class="line"></span><br><span class="line">// 歌曲信息结构体</span><br><span class="line">struct SongInfo &#123;</span><br><span class="line">  String title;</span><br><span class="line">  String prevSong;  // 上一首歌曲</span><br><span class="line">  String nextSong;  // 下一首歌曲</span><br><span class="line">  int duration;</span><br><span class="line">  int seek;</span><br><span class="line">  String status;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 命令定义</span><br><span class="line">enum Command &#123;</span><br><span class="line">  CMD_PLAY,</span><br><span class="line">  CMD_PAUSE, </span><br><span class="line">  CMD_NEXT,</span><br><span class="line">  CMD_PREV,</span><br><span class="line">  CMD_PLAY_SONG</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 按钮状态跟踪（用于防抖）</span><br><span class="line">unsigned long lastPressTime = 0;</span><br><span class="line">const uint16_t DEBOUNCE_DELAY = 600; // 防抖延迟(ms)</span><br><span class="line"></span><br><span class="line">// 添加全局变量用于息屏控制</span><br><span class="line">unsigned long lastActiveTime = 0; // 最后一次活动时间</span><br><span class="line">const unsigned long SCREEN_OFF_DELAY = 10 * 60 * 1000; // 10分钟（毫秒）</span><br><span class="line">bool screenOn = true; // 屏幕状态</span><br><span class="line">SongInfo lastInfo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 发送命令到串口</span><br><span class="line">void sendCommand(Command cmd, int dataLength = 0, byte* data = nullptr) &#123;</span><br><span class="line">  switch(cmd) &#123;</span><br><span class="line">    case CMD_PLAY:</span><br><span class="line">      Serial.println(&quot;PLAY&quot;);  // 使用println自动添加\r\n</span><br><span class="line"></span><br><span class="line">      break;</span><br><span class="line">    case CMD_PAUSE:</span><br><span class="line">      Serial.println(&quot;PAUSE&quot;);</span><br><span class="line"></span><br><span class="line">      break;</span><br><span class="line">    case CMD_NEXT:</span><br><span class="line">      Serial.println(&quot;NEXT&quot;);</span><br><span class="line"></span><br><span class="line">      break;</span><br><span class="line">    case CMD_PREV:</span><br><span class="line">      Serial.println(&quot;PREV&quot;);</span><br><span class="line"></span><br><span class="line">      break;</span><br><span class="line">    case CMD_PLAY_SONG:</span><br><span class="line">      if(dataLength &gt; 0 &amp;&amp; data != nullptr) &#123;</span><br><span class="line">        Serial.print(&quot;SONG:&quot;);</span><br><span class="line">        Serial.println(data[0]);  // 使用println</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      break;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  delay(20); // 给 Linux 足够时间接收</span><br><span class="line">  Serial.flush();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 关闭屏幕</span><br><span class="line">void turnOffScreen() &#123;</span><br><span class="line">  u8g2.clearBuffer();</span><br><span class="line">  u8g2.sendBuffer();</span><br><span class="line">  screenOn = false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 打开屏幕</span><br><span class="line">void turnOnScreen() &#123;</span><br><span class="line">  screenOn = true;</span><br><span class="line">  // 屏幕内容会在下次updateDisplay调用时刷新</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 修改按键处理函数，返回是否有按键按下</span><br><span class="line">bool handleButtonPress() &#123;</span><br><span class="line">  // 防抖检查</span><br><span class="line">  static unsigned long lastPressTime = 0;</span><br><span class="line">  if (millis() - lastPressTime &lt; DEBOUNCE_DELAY) return false;</span><br><span class="line">  </span><br><span class="line">  bool buttonPressed = false;</span><br><span class="line">  </span><br><span class="line">  // 检测按键按下（低电平触发）</span><br><span class="line">  if (digitalRead(BUTTON_PLAY) == LOW) &#123;</span><br><span class="line">    sendCommand(CMD_PLAY);</span><br><span class="line">    lastPressTime = millis();</span><br><span class="line">    buttonPressed = true;</span><br><span class="line">  &#125;</span><br><span class="line">  else if (digitalRead(BUTTON_PAUSE) == LOW) &#123;</span><br><span class="line">    sendCommand(CMD_PAUSE);</span><br><span class="line">    lastPressTime = millis();</span><br><span class="line">    buttonPressed = true;</span><br><span class="line">  &#125;</span><br><span class="line">  else if (digitalRead(BUTTON_NEXT) == LOW) &#123;</span><br><span class="line">    sendCommand(CMD_NEXT);</span><br><span class="line">    lastPressTime = millis();</span><br><span class="line">    buttonPressed = true;</span><br><span class="line">  &#125;</span><br><span class="line">  else if (digitalRead(BUTTON_PREV) == LOW) &#123;</span><br><span class="line">    sendCommand(CMD_PREV);</span><br><span class="line">    lastPressTime = millis();</span><br><span class="line">    buttonPressed = true;</span><br><span class="line">  &#125;</span><br><span class="line">  #if GATEWAY</span><br><span class="line">  else if (digitalRead(BUTTON_SONG1) == LOW) &#123;</span><br><span class="line">    byte songNum = 1;</span><br><span class="line">    sendCommand(CMD_PLAY_SONG, 1, &amp;songNum);</span><br><span class="line">    lastPressTime = millis();</span><br><span class="line">    buttonPressed = true;</span><br><span class="line">  &#125;</span><br><span class="line">  else if (digitalRead(BUTTON_SONG2) == LOW) &#123;</span><br><span class="line">    byte songNum = 2;</span><br><span class="line">    sendCommand(CMD_PLAY_SONG, 1, &amp;songNum);</span><br><span class="line">    lastPressTime = millis();</span><br><span class="line">    buttonPressed = true;</span><br><span class="line">  &#125;</span><br><span class="line">  else if (digitalRead(BUTTON_SONG3) == LOW) &#123;</span><br><span class="line">    byte songNum = 3;</span><br><span class="line">    sendCommand(CMD_PLAY_SONG, 1, &amp;songNum);</span><br><span class="line">    lastPressTime = millis();</span><br><span class="line">    buttonPressed = true;</span><br><span class="line">  &#125;</span><br><span class="line">  else if (digitalRead(BUTTON_SONG4) == LOW) &#123;</span><br><span class="line">    byte songNum = 4;</span><br><span class="line">    sendCommand(CMD_PLAY_SONG, 1, &amp;songNum);</span><br><span class="line">    lastPressTime = millis();</span><br><span class="line">    buttonPressed = true;</span><br><span class="line">  &#125;</span><br><span class="line">  #endif</span><br><span class="line">  </span><br><span class="line">  if (buttonPressed) &#123;</span><br><span class="line">    if (!screenOn) turnOnScreen();</span><br><span class="line">    lastActiveTime = millis();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return buttonPressed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void setup() &#123;</span><br><span class="line"></span><br><span class="line">  pinMode(BUTTON_PAUSE, INPUT_PULLUP);</span><br><span class="line">  pinMode(BUTTON_PLAY, INPUT_PULLUP);</span><br><span class="line">  pinMode(BUTTON_NEXT, INPUT_PULLUP);</span><br><span class="line">  pinMode(BUTTON_PREV, INPUT_PULLUP);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  #if  GATEWAY</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  pinMode(BUTTON_SONG1, INPUT_PULLUP);</span><br><span class="line">  pinMode(BUTTON_SONG2, INPUT_PULLUP);</span><br><span class="line">  pinMode(BUTTON_SONG3, INPUT_PULLUP);</span><br><span class="line">  pinMode(BUTTON_SONG4, INPUT_PULLUP);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  #endif</span><br><span class="line"></span><br><span class="line">  Serial.begin (115200);</span><br><span class="line"></span><br><span class="line">  //Mount FS</span><br><span class="line">  </span><br><span class="line">  Serial.println(&quot;Mounting FS...&quot;);</span><br><span class="line">   if (!SPIFFS.begin(true)) &#123;</span><br><span class="line">    //Serial.println(&quot;SPIFFS mount failed&quot;);</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  u8g2.begin();  // 初始化屏幕</span><br><span class="line">  u8g2.clearBuffer(); // 清空缓冲区  </span><br><span class="line">  u8g2.setFont(u8g2_font_wqy12_t_gb2312);</span><br><span class="line">  u8g2.setContrast(0); // 设置对比度 (0-255)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // 显示初始化界面</span><br><span class="line">  u8g2.drawUTF8(0, 15, &quot;等待 Volumio 数据...&quot;);</span><br><span class="line">  u8g2.sendBuffer();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  lastActiveTime = millis();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SongInfo parseJsonFull(String jsonStr) &#123;</span><br><span class="line">  SongInfo info;</span><br><span class="line">  DynamicJsonDocument doc(2048);</span><br><span class="line">  DeserializationError error = deserializeJson(doc, jsonStr);</span><br><span class="line"></span><br><span class="line">  if (error) &#123;</span><br><span class="line">    // 打印错误信息</span><br><span class="line">    info.title = &quot;数据错误&quot;;</span><br><span class="line">    info.prevSong = &quot;未知&quot;;</span><br><span class="line">    info.nextSong = &quot;未知&quot;;</span><br><span class="line">    info.duration = 1;</span><br><span class="line">    info.seek = 0;</span><br><span class="line">    info.status = &quot;stop&quot;;</span><br><span class="line">    return info;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  info.title = doc[&quot;title&quot;] | &quot;无歌曲&quot;;</span><br><span class="line">  info.prevSong = doc[&quot;prevSong&quot;] | &quot;无&quot;;</span><br><span class="line">  info.nextSong = doc[&quot;nextSong&quot;] | &quot;无&quot;;</span><br><span class="line">  info.status = doc[&quot;status&quot;] | &quot;stop&quot;;</span><br><span class="line">  info.duration = doc[&quot;duration&quot;] | 1;</span><br><span class="line">  info.seek = doc[&quot;seek&quot;] | 0;</span><br><span class="line"></span><br><span class="line">  if (info.duration &lt;= 0) info.duration = 1;</span><br><span class="line">  if (info.seek &lt; 0) info.seek = 0;</span><br><span class="line">  if (info.seek &gt;= info.duration) info.seek = info.duration - 1;</span><br><span class="line"></span><br><span class="line">  return info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 解析 JSON 数据</span><br><span class="line">SongInfo parseJson(String jsonStr) &#123;</span><br><span class="line">  SongInfo info;</span><br><span class="line">  DynamicJsonDocument doc(2048);</span><br><span class="line">  DeserializationError error = deserializeJson(doc, jsonStr);</span><br><span class="line"></span><br><span class="line">  if (error) &#123;</span><br><span class="line">    info.title = &quot;数据错误&quot;;</span><br><span class="line">    info.prevSong = &quot;未知&quot;;</span><br><span class="line">    info.nextSong = &quot;未知&quot;;</span><br><span class="line">    return info;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 安全提取字段 (带默认值)</span><br><span class="line">  info.title = doc[&quot;title&quot;] | &quot;无歌曲&quot;;</span><br><span class="line">  info.prevSong = doc[&quot;prevSong&quot;] | &quot;无&quot;;</span><br><span class="line">  info.nextSong = doc[&quot;nextSong&quot;] | &quot;无&quot;;</span><br><span class="line">  info.status = doc[&quot;status&quot;] | &quot;stop&quot;;</span><br><span class="line">  info.duration = doc[&quot;duration&quot;] | 1;  // 防止除零</span><br><span class="line">  info.seek = doc[&quot;seek&quot;] | 0;</span><br><span class="line"></span><br><span class="line">  // 强制数据有效性</span><br><span class="line">  if (info.duration &lt;= 0) info.duration = 1;</span><br><span class="line">  if (info.seek &lt; 0) info.seek = 0;</span><br><span class="line">  if (info.seek &gt;= info.duration) info.seek = info.duration - 1;</span><br><span class="line"></span><br><span class="line">  return info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 安全映射函数 (防止 min==max 崩溃)</span><br><span class="line">int mapSafe(int value, int in_min, int in_max, int out_min, int out_max) &#123;</span><br><span class="line">  if (in_min == in_max) return out_min;</span><br><span class="line">  value = constrain(value, in_min, in_max);</span><br><span class="line">  return (value - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 更新 OLED 显示 (完整歌曲名，无按键提示)</span><br><span class="line">void updateDisplay(const SongInfo &amp;info) &#123;</span><br><span class="line">  // 如果屏幕是关闭状态，直接返回</span><br><span class="line">  if (!screenOn) &#123;</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  u8g2.clearBuffer();</span><br><span class="line">  </span><br><span class="line">  // 1. 显示当前歌曲标题 (使用中文字体，第一行)</span><br><span class="line">  u8g2.setFont(u8g2_font_wqy12_t_gb2312);</span><br><span class="line">  String displayTitle = info.title;</span><br><span class="line">  // 不进行截断，直接显示完整歌名</span><br><span class="line">  u8g2.drawUTF8(0, 12, displayTitle.c_str());</span><br><span class="line"></span><br><span class="line">  // 2. 显示上一首歌曲 (使用中文字体，第二行)</span><br><span class="line">  String prevSong = &quot;前:&quot; + info.prevSong;</span><br><span class="line">  // 不进行截断，直接显示完整歌名</span><br><span class="line">  u8g2.drawUTF8(0, 24, prevSong.c_str());</span><br><span class="line"></span><br><span class="line">  // 3. 显示下一首歌曲 (使用中文字体，第三行)</span><br><span class="line">  String nextSong = &quot;后:&quot; + info.nextSong;</span><br><span class="line">  // 不进行截断，直接显示完整歌名</span><br><span class="line">  u8g2.drawUTF8(0, 36, nextSong.c_str());</span><br><span class="line"></span><br><span class="line">  // 4. 绘制进度条</span><br><span class="line">  int progressWidth = mapSafe(info.seek, 0, info.duration, 0, 128);</span><br><span class="line">  u8g2.drawFrame(0, 44, 128, 6);</span><br><span class="line">  u8g2.drawBox(0, 44, progressWidth, 6);</span><br><span class="line"></span><br><span class="line">  // 5. 显示时间和状态</span><br><span class="line">  u8g2.setFont(u8g2_font_5x7_tf); // 使用5x7小字体</span><br><span class="line">  char timeStr[16];</span><br><span class="line">  snprintf(timeStr, sizeof(timeStr), &quot;%02d:%02d/%02d:%02d&quot;, </span><br><span class="line">           info.seek / 60, info.seek % 60,</span><br><span class="line">           info.duration / 60, info.duration % 60);</span><br><span class="line">  u8g2.drawStr(0, 58, timeStr);</span><br><span class="line">  </span><br><span class="line">  // 播放状态 (使用中文字体)</span><br><span class="line">  u8g2.setFont(u8g2_font_wqy12_t_gb2312);</span><br><span class="line">  String statusText = (info.status == &quot;play&quot;) ? &quot;播放&quot; : &quot;暂停&quot;;</span><br><span class="line">  u8g2.drawUTF8(80, 58, statusText.c_str());</span><br><span class="line"></span><br><span class="line">  u8g2.sendBuffer();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 仅更新进度条和当前播放时间</span><br><span class="line">void updateSeekOnly(int seek, int duration) &#123;</span><br><span class="line">  // 绘制进度条</span><br><span class="line">  int progressWidth = mapSafe(seek, 0, duration, 0, 128);</span><br><span class="line">  u8g2.drawFrame(0, 44, 128, 6);</span><br><span class="line">  u8g2.drawBox(0, 44, progressWidth, 6);</span><br><span class="line"></span><br><span class="line">  // 更新时间显示</span><br><span class="line">  u8g2.setFont(u8g2_font_5x7_tf); // 小字体</span><br><span class="line">  char timeStr[16];</span><br><span class="line">  snprintf(timeStr, sizeof(timeStr), &quot;%02d:%02d/%02d:%02d&quot;,</span><br><span class="line">           seek / 60, seek % 60,</span><br><span class="line">           duration / 60, duration % 60);</span><br><span class="line">  u8g2.drawStr(0, 58, timeStr);</span><br><span class="line"></span><br><span class="line">  // 保留播放状态显示</span><br><span class="line">  u8g2.setFont(u8g2_font_wqy12_t_gb2312);</span><br><span class="line">  String statusText = (lastInfo.status == &quot;play&quot;) ? &quot;播放&quot; : &quot;暂停&quot;;</span><br><span class="line">  u8g2.drawUTF8(80, 58, statusText.c_str());</span><br><span class="line"></span><br><span class="line">  u8g2.sendBuffer();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 修改检查息屏的函数</span><br><span class="line">void checkScreenTimeout() &#123;</span><br><span class="line">  unsigned long currentTime = millis();</span><br><span class="line">  </span><br><span class="line">  // 如果正在播放，保持屏幕开启</span><br><span class="line">  if (lastInfo.status == &quot;play&quot;) &#123;</span><br><span class="line">    if (!screenOn) turnOnScreen();</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  // 如果是暂停状态，检查是否超时</span><br><span class="line">  if (lastInfo.status == &quot;pause&quot; || lastInfo.status == &quot;stop&quot;) &#123;</span><br><span class="line">    if (screenOn &amp;&amp; (currentTime - lastActiveTime &gt; SCREEN_OFF_DELAY)) &#123;</span><br><span class="line">      turnOffScreen();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 修改loop函数中的数据处理逻辑</span><br><span class="line">void loop() &#123;</span><br><span class="line">  if (Serial.available()) &#123;</span><br><span class="line">    String line = Serial.readStringUntil(&#x27;\n&#x27;);</span><br><span class="line">    line.trim();</span><br><span class="line">    if (line.length() &gt; 0) &#123;</span><br><span class="line">      DynamicJsonDocument doc(2048);</span><br><span class="line">      DeserializationError err = deserializeJson(doc, line);</span><br><span class="line">      </span><br><span class="line">      if (!err &amp;&amp; doc.containsKey(&quot;seek&quot;) &amp;&amp; !doc.containsKey(&quot;title&quot;)) &#123;</span><br><span class="line">        // 进度更新</span><br><span class="line">        int seek = doc[&quot;seek&quot;];</span><br><span class="line">        updateSeekOnly(seek, lastInfo.duration);</span><br><span class="line">        lastInfo.seek = seek;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        // 完整状态更新</span><br><span class="line">        SongInfo newInfo = parseJsonFull(line);</span><br><span class="line">        </span><br><span class="line">        // 检查状态是否有重要变化</span><br><span class="line">        bool significantChange = (newInfo.title != lastInfo.title || </span><br><span class="line">                                 newInfo.status != lastInfo.status);</span><br><span class="line">        </span><br><span class="line">        lastInfo = newInfo;</span><br><span class="line">        updateDisplay(lastInfo);</span><br><span class="line">        </span><br><span class="line">        // 只有重要变化才重置息屏计时器</span><br><span class="line">        if (significantChange) &#123;</span><br><span class="line">          lastActiveTime = millis();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 按键操作重置息屏计时器</span><br><span class="line">  if (handleButtonPress()) &#123;</span><br><span class="line">    lastActiveTime = millis();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  checkScreenTimeout();</span><br><span class="line">  delay(50);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>
    
      <div class="full-width auto-padding tags">
        
          <a href="/tags/linux/" rel="nofollow"><i class="fas fa-hashtag fa-fw"></i>linux</a>
        
      </div>
    
  </section>
</article>

          </div>
        
      
    
  </section>
  
    
    <!-- 根据主题中的设置决定是否在archive中针对摘要部分的MathJax公式加载mathjax.js文件 -->
    
    

  


	
</div>
<aside class='l_side'>
  
    
    
      
        
          
          
            <section class='widget author'>
  <div class='content material'>
    
      <div class='avatar'>
        <img class='avatar' src='/images/head.jpg'/>
      </div>
    
    
    
      <div class="social-wrapper">
        
          
            <a href="/atom.xml"
              class="social fas fa-rss flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
        
          
            <a href="https://github.com/pazulin"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://music.163.com/"
              class="social fas fa-headphones-alt flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
      </div>
    
  </div>
</section>

          
        
      
        
          
          
            

          
        
      
        
          
          
            <section class='widget grid'>
  
<header class='material'>
  <div><i class="fas fa-map-signs fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;站内导航</div>
  
</header>

  <div class='content material'>
    <ul class="grid navgation">
      
        <li><a class="flat-box" title="/" href="/"
          
          
          id="home">
          
            <i class="fas fa-clock fa-fw" aria-hidden="true"></i>
          
          近期文章
        </a></li>
      
        <li><a class="flat-box" title="/archives/" href="/archives/"
          
            rel="nofollow"
          
          
          id="archives">
          
            <i class="fas fa-archive fa-fw" aria-hidden="true"></i>
          
          文章归档
        </a></li>
      
        <li><a class="flat-box" title="/projects/" href="/projects/"
          
          
          id="projects">
          
            <i class="fas fa-code-branch fa-fw" aria-hidden="true"></i>
          
          开源项目
        </a></li>
      
        <li><a class="flat-box" title="/about/" href="/about/"
          
            rel="nofollow"
          
          
          id="about">
          
            <i class="fas fa-info-circle fa-fw" aria-hidden="true"></i>
          
          关于小站
        </a></li>
      
    </ul>
  </div>
</section>

          
        
      
        
          
          
            
  <section class='widget category'>
    
<header class='material'>
  <div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;文章分類</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/categories/"
    title="/categories/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content material'>
      <ul class="entry">
        
          <li><a class="flat-box" title="/categories/AI/" href="/categories/AI/"><div class='name'>AI</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/PC/" href="/categories/PC/"><div class='name'>PC</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/linux/" href="/categories/linux/"><div class='name'>linux</div><div class='badge'>(16)</div></a></li>
        
          <li><a class="flat-box" title="/categories/live/" href="/categories/live/"><div class='name'>live</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/nodemcu/" href="/categories/nodemcu/"><div class='name'>nodemcu</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/openwrt/" href="/categories/openwrt/"><div class='name'>openwrt</div><div class='badge'>(7)</div></a></li>
        
          <li><a class="flat-box" title="/categories/%E4%B8%AD%E5%8C%BB/" href="/categories/%E4%B8%AD%E5%8C%BB/"><div class='name'>中医</div><div class='badge'>(4)</div></a></li>
        
          <li><a class="flat-box" title="/categories/%E5%AF%93%E8%A8%80/" href="/categories/%E5%AF%93%E8%A8%80/"><div class='name'>寓言</div><div class='badge'>(3)</div></a></li>
        
          <li><a class="flat-box" title="/categories/%E6%88%91%E7%9A%84%E4%BD%9C%E5%93%81/" href="/categories/%E6%88%91%E7%9A%84%E4%BD%9C%E5%93%81/"><div class='name'>我的作品</div><div class='badge'>(1)</div></a></li>
        
      </ul>
    </div>
  </section>


          
        
      
        
          
          
            
  <section class='widget tagcloud'>
    
<header class='material'>
  <div><i class="fas fa-fire fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;熱門標籤</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/tags/"
    title="/tags/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content material'>
      <a href="/tags/AI-armbian/" style="font-size: 14px; color: #999">AI armbian</a> <a href="/tags/OrangePi/" style="font-size: 14px; color: #999">OrangePi</a> <a href="/tags/PC/" style="font-size: 14px; color: #999">PC</a> <a href="/tags/linux/" style="font-size: 24px; color: #555">linux</a> <a href="/tags/live/" style="font-size: 14px; color: #999">live</a> <a href="/tags/nodemcu/" style="font-size: 14px; color: #999">nodemcu</a> <a href="/tags/openwrt/" style="font-size: 20.67px; color: #6c6c6c">openwrt</a> <a href="/tags/%E4%B8%AD%E5%8C%BB/" style="font-size: 17.33px; color: #828282">中医</a> <a href="/tags/%E4%B8%AD%E5%8C%BB-%E7%BB%8F%E6%96%B9/" style="font-size: 14px; color: #999">中医 经方</a> <a href="/tags/%E5%AF%93%E8%A8%80/" style="font-size: 17.33px; color: #828282">寓言</a>
    </div>
  </section>


          
        
      
        
          
          
            



          
        
      
    

  
</aside>

<footer id="footer" class="clearfix">
  
  
    <div class="social-wrapper">
      
        
          <a href="/atom.xml"
            class="social fas fa-rss flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
      
        
          <a href="https://github.com/pazulin"
            class="social fab fa-github flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://music.163.com/"
            class="social fas fa-headphones-alt flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
    </div>
  
  <br>
  <div><p>博客內容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh_TW">姓名標示-非商業性-相同方式分享 4.0 國際 (CC BY-NC-SA 4.0) 協議</a></p>
</div>
  <div>
    本站使用
    <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename">Material X</a>
    作为主题
    
      ，
      总访问量为
      <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
      次
    
    。
  </div>
</footer>
<script>setLoadingBarProgress(80);</script>




	<!-- 根据主题中的设置决定是否在archive中针对摘要部分的MathJax公式加载mathjax.js文件 -->
	

	


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>

  <script>
    var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
    var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
    var ALGOLIA_API_KEY = "";
    var ALGOLIA_APP_ID = "";
    var ALGOLIA_INDEX_NAME = "";
    var AZURE_SERVICE_NAME = "";
    var AZURE_INDEX_NAME = "";
    var AZURE_QUERY_KEY = "";
    var BAIDU_API_ID = "";
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/"||"/";
    if(!ROOT.endsWith('/'))ROOT += '/';
  </script>

<script src="//instant.page/1.2.2" type="module" integrity="sha384-2xV8M5griQmzyiY3CDqh1dn4z3llDVqZDqzjzcY+jCBCk/a5fXJmuZ/40JJAPeoU"></script>


  <script async src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      const $reveal = $('.reveal');
      if ($reveal.length === 0) return;
      const sr = ScrollReveal({ distance: 0 });
      sr.reveal('.reveal');
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>




  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>
    <script type="text/javascript">
      $(function(){
        if ('.cover') {
          $('.cover').backstretch(
          ["https://img.vim-cn.com/95/3588f724a8ff9af004dda557ab124d3c3bc33f.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        } else {
          $.backstretch(
          ["https://img.vim-cn.com/95/3588f724a8ff9af004dda557ab124d3c3bc33f.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        }
      });
    </script>
  











  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.5/js/app.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.5/js/search.js"></script>





<!-- 复制 -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  let COPY_SUCCESS = "複製成功";
  let COPY_FAILURE = "複製失敗";
  /*页面载入完成后，创建复制按钮*/
  !function (e, t, a) {
    /* code */
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '  <i class="fa fa-copy"></i><span>複製</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });

      clipboard.on('success', function(e) {
        //您可以加入成功提示
        console.info('Action:', e.action);
        console.info('Text:', e.text);
        console.info('Trigger:', e.trigger);
        success_prompt(COPY_SUCCESS);
        e.clearSelection();
      });
      clipboard.on('error', function(e) {
        //您可以加入失败提示
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        fail_prompt(COPY_FAILURE);
      });
    }
    initCopyCode();

  }(window, document);

  /**
   * 弹出式提示框，默认1.5秒自动消失
   * @param message 提示信息
   * @param style 提示样式，有alert-success、alert-danger、alert-warning、alert-info
   * @param time 消失时间
   */
  var prompt = function (message, style, time)
  {
      style = (style === undefined) ? 'alert-success' : style;
      time = (time === undefined) ? 1500 : time*1000;
      $('<div>')
          .appendTo('body')
          .addClass('alert ' + style)
          .html(message)
          .show()
          .delay(time)
          .fadeOut();
  };

  // 成功提示
  var success_prompt = function(message, time)
  {
      prompt(message, 'alert-success', time);
  };

  // 失败提示
  var fail_prompt = function(message, time)
  {
      prompt(message, 'alert-danger', time);
  };

  // 提醒
  var warning_prompt = function(message, time)
  {
      prompt(message, 'alert-warning', time);
  };

  // 信息提示
  var info_prompt = function(message, time)
  {
      prompt(message, 'alert-info', time);
  };

</script>


<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>





  <script>setLoadingBarProgress(100);</script>
</body>
</html>
