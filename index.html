<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>逍遥游</title>
  
  

  

  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.6.3/css/all.min.css">
  

  

  
    
<link rel="stylesheet" href="/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  
  
  <div class="cover-wrapper">
    <cover class='cover  '>
      
        
  <h1 class='title'>逍遥游</h1>


  <div class="m_search">
    <form name="searchform" class="form u-search-form">
      <input type="text" class="input u-search-input" placeholder="" />
      <i class="icon fas fa-search fa-fw"></i>
    </form>
  </div>

<div class='menu navgation'>
  <ul class='h-list'>
    
      
        <li>
          <a class="nav home" href="/"
            
            
            id="home">
            <i class='fas fa-rss fa-fw'></i>&nbsp;文章
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/projects/"
            
            
            id="projects">
            <i class='fas fa-code-branch fa-fw'></i>&nbsp;项目
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/about/"
            
              rel="nofollow"
            
            
            id="about">
            <i class='fas fa-info-circle fa-fw'></i>&nbsp;关于
          </a>
        </li>
      
    
  </ul>
</div>

      
    </cover>
    <header class="l_header material">
  <div id="loading-bar-wrapper">
    <div id="loading-bar" class="material"></div>
  </div>

	<div class='wrapper'>
		<div class="nav-main container container--flex">
      <a class="logo flat-box" href='/' >
        
          逍遥游
        
      </a>
			<div class='menu navgation'>
				<ul class='h-list'>
          
  					
  						<li>
								<a class="nav flat-box" href="/"
                  
                  
                  id="home">
									<i class='fas fa-grin fa-fw'></i>&nbsp;示例
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/categories/"
                  
                    rel="nofollow"
                  
                  
                  id="categories">
									<i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/tags/"
                  
                    rel="nofollow"
                  
                  
                  id="tags">
									<i class='fas fa-hashtag fa-fw'></i>&nbsp;标签
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/archives/"
                  
                    rel="nofollow"
                  
                  
                  id="archives">
									<i class='fas fa-archive fa-fw'></i>&nbsp;归档
								</a>
							</li>
      			
      		
				</ul>
			</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<i class="icon fas fa-search fa-fw"></i>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a class="fas fa-search fa-fw" href='javascript:void(0)'></a></li>
				
				<li class='s-menu'><a class="fas fa-bars fa-fw" href='javascript:void(0)'></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo flat-box"></a>
			<ul class='switcher h-list'>
				<li class='s-comment'><a class="flat-btn fas fa-comments fa-fw" href='javascript:void(0)'></a></li>
        
          <li class='s-toc'><a class="flat-btn fas fa-list fa-fw" href='javascript:void(0)'></a></li>
        
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
    <header>
		<nav class="menu navgation">
      <ul>
        
          
            <li>
							<a class="nav flat-box" href="/"
                
                
                id="home">
								<i class='fas fa-clock fa-fw'></i>&nbsp;近期文章
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/archives/"
                
                  rel="nofollow"
                
                
                id="archives">
								<i class='fas fa-archive fa-fw'></i>&nbsp;文章归档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/projects/"
                
                
                id="projects">
								<i class='fas fa-code-branch fa-fw'></i>&nbsp;开源项目
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/about/"
                
                  rel="nofollow"
                
                
                id="about">
								<i class='fas fa-info-circle fa-fw'></i>&nbsp;关于小站
							</a>
            </li>
          
       
      </ul>
		</nav>
    </header>
	</aside>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      <div class='l_main'>
  
  <section class="post-list">
    
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
    
    
      
        
          <div class='post-wrapper'>
            <article class="post reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2025/11/01/volumio-display-key/">
      volumio增加外置显示屏和按键
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    <a href="https://pazulin.github.io" rel="nofollow">
      
        <i class="fas fa-user" aria-hidden="true"></i>
      
      <p>井蛙</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2025-11-01</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/linux/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>linux</p>
    </a>
  </div>


          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <p>Q7上面跑volumio 2.8,增加一个ESP32C3 的模块, 这个模块有显示屏和按键,显示屏接的是1.3寸OLED 显示屏, 按键接的是一个4个按键的模块,分别接到ESP32C3的GPIO</p>
<p>python 代码如下</p>
<p>‘’’</p>
<h1 id="coding-utf-8"><a href="#coding-utf-8" class="headerlink" title="-- coding: utf-8 --"></a>-<em>- coding: utf-8 -</em>-</h1><p>import serial<br>import time<br>import json<br>import requests<br>import logging<br>from threading import Thread<br>from Queue import Queue<br>import sys</p>
<h1 id="重新加载sys并设置默认编码"><a href="#重新加载sys并设置默认编码" class="headerlink" title="重新加载sys并设置默认编码"></a>重新加载sys并设置默认编码</h1><p>reload(sys)<br>sys.setdefaultencoding(‘utf-8’)</p>
<h1 id="配置日志-抑制-requests-和-urllib3-的日志"><a href="#配置日志-抑制-requests-和-urllib3-的日志" class="headerlink" title="配置日志 - 抑制 requests 和 urllib3 的日志"></a>配置日志 - 抑制 requests 和 urllib3 的日志</h1><p>logging.basicConfig(level&#x3D;logging.INFO, format&#x3D;’%(asctime)s - %(levelname)s - %(message)s’)<br>logging.getLogger(“requests”).setLevel(logging.WARNING)<br>logging.getLogger(“urllib3”).setLevel(logging.WARNING)</p>
<p>SERIAL_PORT &#x3D; ‘&#x2F;dev&#x2F;ttyACM0’<br>BAUD_RATE &#x3D; 115200<br>VOLUMIO_HOST &#x3D; ‘localhost’<br>VOLUMIO_PORT &#x3D; 3000</p>
<p>GET_STATE &#x3D; ‘http:&#x2F;&#x2F;{}:{}&#x2F;api&#x2F;v1&#x2F;getState’.format(VOLUMIO_HOST, VOLUMIO_PORT)<br>GET_QUEUE &#x3D; ‘http:&#x2F;&#x2F;{}:{}&#x2F;api&#x2F;v1&#x2F;getQueue’.format(VOLUMIO_HOST, VOLUMIO_PORT)</p>
<p>SEEK_UPDATE_INTERVAL &#x3D; 2<br>MAX_RETRIES &#x3D; 3<br>RETRY_DELAY &#x3D; 5</p>
<h1 id="创建会话对象，支持连接复用"><a href="#创建会话对象，支持连接复用" class="headerlink" title="创建会话对象，支持连接复用"></a>创建会话对象，支持连接复用</h1><p>session &#x3D; requests.Session()</p>
<p>class VolumioController:<br>    def <strong>init</strong>(self):<br>        self.ser &#x3D; None<br>        self.command_queue &#x3D; Queue()<br>        self.running &#x3D; True<br>        self.volumio_available &#x3D; True<br>        self.serial_available &#x3D; False<br>        self.last_state_data &#x3D; None<br>        self.last_queue_data &#x3D; None<br>        self.data_cache_time &#x3D; 0<br>        self.queue_cache_time &#x3D; 0<br>        self.last_position &#x3D; -1  # 记录上次的位置<br>        self.last_uri &#x3D; “”  # 记录上次的URI，用于检测文件夹切换<br>        self.cache_duration &#x3D; 1.0  # 状态缓存1秒<br>        self.queue_cache_duration &#x3D; 2.0  # 队列缓存2秒，减少时间</p>
<pre><code>def init_serial(self):
    &quot;&quot;&quot;初始化串口连接，支持重试&quot;&quot;&quot;
    retry_count = 0
    while retry_count &lt; MAX_RETRIES and self.running:
        try:
            self.ser = serial.Serial(SERIAL_PORT, BAUD_RATE, timeout=0.5)
            self.serial_available = True
            logging.info(&quot;串口连接成功: %s&quot;, SERIAL_PORT)
            return True
        except Exception as e:
            retry_count += 1
            logging.error(&quot;串口连接失败 (尝试 %d/%d): %s&quot;, retry_count, MAX_RETRIES, str(e))
            if retry_count &lt; MAX_RETRIES:
                time.sleep(RETRY_DELAY)
    
    logging.error(&quot;无法建立串口连接，程序退出&quot;)
    return False

# def truncate_song_name(self, name, max_length=10):
#     &quot;&quot;&quot;截断歌曲名称，直接截取前max_length个字符&quot;&quot;&quot;
#     if not name:
#         return u&quot;未知歌曲&quot;
    
#     # 确保是unicode字符串
#     if not isinstance(name, unicode):
#         try:
#             name = name.decode(&#39;utf-8&#39;)
#         except:
#             name = u&quot;未知歌曲&quot;
    
#     if len(name) &lt;= max_length:
#         return name
    
#     # 直接截取前max_length个字符，不加省略号
#     return name[:max_length]
def truncate_song_name(self, name, max_chinese=10, max_english=20):
    &quot;&quot;&quot;截断歌曲名称，如果包含中文就用10个字符，否则用20个字符&quot;&quot;&quot;
    if not name:
        return u&quot;未知歌曲&quot;
    
    # 确保是unicode字符串
    if not isinstance(name, unicode):
        try:
            name = name.decode(&#39;utf-8&#39;)
        except:
            return u&quot;未知歌曲&quot;
    
    # 检查是否包含中文字符
    has_chinese = any(u&#39;\u4e00&#39; &lt;= char &lt;= u&#39;\u9fff&#39; for char in name)
    
    # 选择最大长度
    max_length = max_chinese if has_chinese else max_english
    
    if len(name) &lt;= max_length:
        return name
    
    return name[:max_length]
    
def safe_volumio_request(self, url, timeout=2, use_cache=False, cache_type=&quot;state&quot;):
    &quot;&quot;&quot;安全的Volumio请求，带重试机制和缓存&quot;&quot;&quot;
    current_time = time.time()
    
    # 使用缓存数据（如果可用且未过期）
    if use_cache:
        cache_duration = self.cache_duration if cache_type == &quot;state&quot; else self.queue_cache_duration
        cache_time = self.data_cache_time if cache_type == &quot;state&quot; else self.queue_cache_time
        cache_data = self.last_state_data if cache_type == &quot;state&quot; else self.last_queue_data
        
        if cache_data and current_time - cache_time &lt; cache_duration:
            if url == GET_STATE and cache_type == &quot;state&quot;:
                return self.last_state_data
            elif url == GET_QUEUE and cache_type == &quot;queue&quot;:
                return self.last_queue_data
    
    for attempt in range(MAX_RETRIES):
        try:
            response = session.get(url, timeout=timeout)
            if response.status_code == 200:
                self.volumio_available = True
                data = response.json()
                
                # 缓存数据
                if url == GET_STATE:
                    self.last_state_data = data
                    self.data_cache_time = current_time
                elif url == GET_QUEUE:
                    self.last_queue_data = data
                    self.queue_cache_time = current_time
                
                return data
            else:
                logging.warning(&quot;Volumio返回错误状态码: %d&quot;, response.status_code)
        except Exception as e:
            logging.warning(&quot;Volumio请求失败 (尝试 %d/%d): %s&quot;, attempt + 1, MAX_RETRIES, str(e))
        
        if attempt &lt; MAX_RETRIES - 1:
            time.sleep(1)
    
    self.volumio_available = False
    logging.error(&quot;Volumio服务不可用&quot;)
    return None

def get_volumio_status(self):
    &quot;&quot;&quot;获取Volumio状态，带降级处理&quot;&quot;&quot;
    state_data = self.safe_volumio_request(GET_STATE, use_cache=True, cache_type=&quot;state&quot;)
    if not state_data:
        return self.get_fallback_status()
    
    try:
        # 修正字段映射
        seek_ms = state_data.get(&#39;seek&#39;, 0)  # 毫秒
        seek = int(seek_ms / 1000)  # 转换为秒
        duration = int(state_data.get(&#39;duration&#39;, 1) or 1)
        title = state_data.get(&#39;title&#39;, u&#39;无歌曲&#39;)
        status = state_data.get(&#39;status&#39;, &#39;stop&#39;)
        current_position = int(state_data.get(&#39;position&#39;, -1))  # 队列中的位置
        current_uri = state_data.get(&#39;uri&#39;, &#39;&#39;)  # 当前歌曲的URI

        # 检测文件夹切换 - 如果URI路径发生变化，强制刷新队列
        force_queue_update = False
        if current_uri and self.last_uri:
            # 提取文件夹路径进行比较
            current_folder = &#39;/&#39;.join(current_uri.split(&#39;/&#39;)[:-1])
            last_folder = &#39;/&#39;.join(self.last_uri.split(&#39;/&#39;)[:-1])
            if current_folder != last_folder:
                logging.info(&quot;检测到文件夹切换，强制刷新队列&quot;)
                force_queue_update = True
        
        self.last_uri = current_uri

        # 简化歌曲名称显示 - 当前歌曲保留完整名称
        display_title = self.truncate_song_name(title, 30)  # 当前歌曲显示30个字符

        # 只有当需要时才获取队列信息
        prev_song = u&#39;无&#39;
        next_song = u&#39;无&#39;
        if status == &#39;play&#39; or status == &#39;pause&#39;:
            # 检查位置是否改变或需要强制更新
            position_changed = (current_position != self.last_position)
            if position_changed or force_queue_update:
                logging.info(&quot;位置变化或强制更新，重新获取队列信息&quot;)
            
            prev_song, next_song = self.get_queue_info(
                current_position, 
                force_update=(position_changed or force_queue_update)
            )
            self.last_position = current_position
        
        return &#123;
            &quot;title&quot;: display_title,
            &quot;prevSong&quot;: prev_song,
            &quot;nextSong&quot;: next_song,
            &quot;duration&quot;: duration,
            &quot;seek&quot;: seek,
            &quot;status&quot;: status
        &#125;
    except Exception as e:
        logging.error(&quot;解析Volumio状态数据失败: %s, 原始数据: %s&quot;, str(e), state_data)
        return self.get_fallback_status()

def get_queue_info(self, position, force_update=False):
    &quot;&quot;&quot;获取队列信息&quot;&quot;&quot;
    # 修正：只有当位置有效时才获取队列
    if position &lt; 0:
        return u&#39;无&#39;, u&#39;无&#39;
        
    # 如果强制更新，不使用缓存
    use_cache = not force_update
    queue_data = self.safe_volumio_request(GET_QUEUE, use_cache=use_cache, cache_type=&quot;queue&quot;)
    if not queue_data:
        return u&#39;未知&#39;, u&#39;未知&#39;
    
    try:
        queue = queue_data.get(&#39;queue&#39;, [])
        prev_song = u&#39;无&#39;
        next_song = u&#39;无&#39;
        
        if 0 &lt;= position &lt; len(queue):
            if position &gt; 0:
                prev_item = queue[position - 1]
                # 尝试多个可能的字段名
                prev_name = prev_item.get(&#39;name&#39;, prev_item.get(&#39;title&#39;, u&#39;无&#39;))
                # 队列中的歌曲名称截取前10个字符
                prev_song = self.truncate_song_name(prev_name, 10)
            
            if position &lt; len(queue) - 1:
                next_item = queue[position + 1]
                # 尝试多个可能的字段名
                next_name = next_item.get(&#39;name&#39;, next_item.get(&#39;title&#39;, u&#39;无&#39;))
                # 队列中的歌曲名称截取前10个字符
                next_song = self.truncate_song_name(next_name, 10)
        
        logging.debug(&quot;队列信息: 位置=%d, 上一首=%s, 下一首=%s&quot;, position, prev_song, next_song)
        return prev_song, next_song
    except Exception as e:
        logging.error(&quot;解析队列信息失败: %s, 队列数据: %s&quot;, str(e), queue_data)
        return u&#39;未知&#39;, u&#39;未知&#39;

def get_fallback_status(self):
    &quot;&quot;&quot;返回降级状态&quot;&quot;&quot;
    return &#123;
        &quot;title&quot;: u&quot;服务不可用&quot;,
        &quot;prevSong&quot;: u&quot;未知&quot;,
        &quot;nextSong&quot;: u&quot;未知&quot;,
        &quot;duration&quot;: 1,
        &quot;seek&quot;: 0,
        &quot;status&quot;: &quot;stop&quot;
    &#125;

def safe_serial_send(self, data):
    &quot;&quot;&quot;安全的串口数据发送&quot;&quot;&quot;
    if not self.serial_available or not self.ser:
        return False
    
    try:
        # 确保所有字符串都是UTF-8编码的普通字符串，而不是Unicode对象
        ascii_safe_data = &#123;&#125;
        for key, value in data.items():
            if isinstance(value, unicode):
                # 将Unicode转换为UTF-8编码的字符串
                ascii_safe_data[key] = value.encode(&#39;utf-8&#39;)
            else:
                ascii_safe_data[key] = value
        
        # 使用 ensure_ascii=False 来支持中文
        json_str = json.dumps(ascii_safe_data, ensure_ascii=False) + &#39;\n&#39;
        
        # 在 Python 2.7 中，需要显式编码为 UTF-8
        self.ser.write(json_str.encode(&#39;utf-8&#39;))
        return True
    except Exception as e:
        logging.error(&quot;串口发送失败: %s&quot;, str(e))
        self.serial_available = False
        self.try_reconnect_serial()
        return False

def try_reconnect_serial(self):
    &quot;&quot;&quot;尝试重新连接串口&quot;&quot;&quot;
    if self.ser:
        try:
            self.ser.close()
        except:
            pass
    
    logging.info(&quot;尝试重新连接串口...&quot;)
    self.serial_available = self.init_serial()

def handle_esp32_command(self, cmd):
    &quot;&quot;&quot;处理ESP32命令&quot;&quot;&quot;
    cmd = cmd.strip().upper()
    command_urls = &#123;
        &#39;PLAY&#39;: &#39;http://&#123;&#125;:&#123;&#125;/api/v1/commands/?cmd=play&#39;.format(VOLUMIO_HOST, VOLUMIO_PORT),
        &#39;PAUSE&#39;: &#39;http://&#123;&#125;:&#123;&#125;/api/v1/commands/?cmd=pause&#39;.format(VOLUMIO_HOST, VOLUMIO_PORT),
        &#39;NEXT&#39;: &#39;http://&#123;&#125;:&#123;&#125;/api/v1/commands/?cmd=next&#39;.format(VOLUMIO_HOST, VOLUMIO_PORT),
        &#39;PREV&#39;: &#39;http://&#123;&#125;:&#123;&#125;/api/v1/commands/?cmd=prev&#39;.format(VOLUMIO_HOST, VOLUMIO_PORT)
    &#125;
    
    if cmd in command_urls:
        # 执行命令后，强制更新队列信息
        self.safe_volumio_request(command_urls[cmd], timeout=1)
        # 清除队列缓存，确保下次获取最新数据
        self.last_queue_data = None
        self.queue_cache_time = 0
        # 重置位置跟踪
        self.last_position = -1
    else:
        logging.warning(&quot;未知命令: %s&quot;, cmd)

def read_serial_commands(self):
    &quot;&quot;&quot;读取串口命令的独立线程&quot;&quot;&quot;
    while self.running:
        if self.serial_available and self.ser and self.ser.inWaiting():
            try:
                line = self.ser.readline().strip()
                if line:
                    # Python 2.7 解码处理
                    try:
                        line = line.decode(&#39;utf-8&#39;)
                    except UnicodeDecodeError:
                        try:
                            line = line.decode(&#39;gbk&#39;)
                        except:
                            line = line.decode(&#39;latin-1&#39;)
                    
                    logging.info(&quot;收到ESP32命令: %s&quot;, line)
                    self.handle_esp32_command(line)
            except Exception as e:
                logging.error(&quot;串口读取错误: %s&quot;, str(e))
                self.serial_available = False
        time.sleep(0.1)

def run(self):
    &quot;&quot;&quot;主运行循环&quot;&quot;&quot;
    if not self.init_serial():
        return
    
    # 启动串口读取线程
    serial_thread = Thread(target=self.read_serial_commands)
    serial_thread.daemon = True
    serial_thread.start()
    
    last_title = &quot;&quot;
    last_status = &quot;&quot;
    last_seek_sent = -1
    last_seek_time = time.time()
    last_health_check = time.time()
    last_full_update = 0
    
    while self.running:
        try:
            current_time = time.time()
            
            # 健康检查（减少频率）
            if current_time - last_health_check &gt; 30:
                if not self.volumio_available:
                    logging.info(&quot;尝试恢复Volumio连接...&quot;)
                    test_data = self.safe_volumio_request(GET_STATE, timeout=1)
                    if test_data:
                        logging.info(&quot;Volumio连接已恢复&quot;)
                last_health_check = current_time
            
            # 获取状态并发送
            song_info = self.get_volumio_status()
            
            now = time.time()
            # 减少完整状态发送频率
            needs_full_update = (song_info[&#39;title&#39;] != last_title or 
                               song_info[&#39;status&#39;] != last_status or
                               now - last_full_update &gt; 30)  # 每30秒强制更新一次
            
            if needs_full_update:
                if self.safe_serial_send(song_info):
                    last_title = song_info[&#39;title&#39;]
                    last_status = song_info[&#39;status&#39;]
                    last_seek_sent = song_info[&#39;seek&#39;]
                    last_seek_time = now
                    last_full_update = now
            # 如果正在播放且 seek 超过更新时间间隔 → 发送 seek 更新
            elif (song_info[&#39;status&#39;] == &#39;play&#39; and 
                  (now - last_seek_time &gt;= SEEK_UPDATE_INTERVAL)):
                if song_info[&#39;seek&#39;] != last_seek_sent:
                    if self.safe_serial_send(&#123;&quot;seek&quot;: song_info[&#39;seek&#39;]&#125;):
                        last_seek_sent = song_info[&#39;seek&#39;]
                last_seek_time = now
            
            time.sleep(0.2)  # 增加休眠时间，减少请求频率
            
        except Exception as e:
            logging.error(&quot;主循环发生未预期错误: %s&quot;, str(e))
            time.sleep(1)

def stop(self):
    &quot;&quot;&quot;停止运行&quot;&quot;&quot;
    self.running = False
    if self.ser:
        try:
            self.ser.close()
        except:
            pass
    session.close()
</code></pre>
<p>def main():<br>    controller &#x3D; VolumioController()<br>    try:<br>        controller.run()<br>    except KeyboardInterrupt:<br>        logging.info(“收到中断信号，程序退出”)<br>    except Exception as e:<br>        logging.error(“程序运行出错: %s”, str(e))<br>    finally:<br>        controller.stop()</p>
<p>if <strong>name</strong> &#x3D;&#x3D; ‘<strong>main</strong>‘:<br>    main()</p>
<p>‘’’</p>
<p>把这个脚本加入系统服务<br>sudo nano &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;esp32_remote.service</p>
<p>‘’’</p>
<p>[Unit]<br>Description&#x3D;ESP32 Volumio Remote Control Service<br>After&#x3D;network.target</p>
<p>[Service]<br>Type&#x3D;simple<br>User&#x3D;volumio<br>WorkingDirectory&#x3D;&#x2F;home&#x2F;volumio<br>ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;python &#x2F;home&#x2F;volumio&#x2F;remote_esp32.py<br>Restart&#x3D;always<br>RestartSec&#x3D;5</p>
<p>[Install]<br>WantedBy&#x3D;multi-user.target</p>
<p>‘’’</p>
<p>ESP32 那边代码如下,主要部分</p>
<p>‘’’</p>
<p>sudo systemctl daemon-reload<br>sudo systemctl start esp32_remote.service<br>sudo systemctl status esp32_remote.service</p>
<p>&#x2F;&#x2F; 初始化 SH1106，I2C 接口<br>U8G2_SH1106_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0, &#x2F;* reset&#x3D;<em>&#x2F; U8X8_PIN_NONE,<br>   &#x2F;</em> SCL&#x3D;<em>&#x2F; 5,  &#x2F;&#x2F; 自定义 SCL 引脚<br>  &#x2F;</em> SDA&#x3D;*&#x2F; 4   &#x2F;&#x2F; 自定义 SDA 引脚<br>  );</p>
<p>&#x2F;&#x2F; 定义按键引脚<br>#define BUTTON_PAUSE 8   &#x2F;&#x2F; GPIO0 连接按键1（暂停）<br>#define BUTTON_PLAY 20    &#x2F;&#x2F; GPIO1 连接按键2（播放）<br>#define BUTTON_NEXT 21    &#x2F;&#x2F; GPIO2 连接按键3（下一首）<br>#define BUTTON_PREV 1   &#x2F;&#x2F; GPIO3 连接按键4（上一首）</p>
<p>#define BUTTON_SONG1 2   &#x2F;&#x2F; GPIO4 连接按键5（歌曲1）<br>#define BUTTON_SONG2 10   &#x2F;&#x2F; GPIO5 连接按键6（歌曲2）<br>#define BUTTON_SONG3 6   &#x2F;&#x2F; GPIO6 连接按键7（歌曲3）<br>#define BUTTON_SONG4 7   &#x2F;&#x2F; GPIO7 连接按键8（歌曲4）</p>
<p>&#x2F;&#x2F; 歌曲信息结构体<br>struct SongInfo {<br>  String title;<br>  String prevSong;  &#x2F;&#x2F; 上一首歌曲<br>  String nextSong;  &#x2F;&#x2F; 下一首歌曲<br>  int duration;<br>  int seek;<br>  String status;<br>};</p>
<p>&#x2F;&#x2F; 命令定义<br>enum Command {<br>  CMD_PLAY,<br>  CMD_PAUSE,<br>  CMD_NEXT,<br>  CMD_PREV,<br>  CMD_PLAY_SONG<br>};</p>
<p>&#x2F;&#x2F; 按钮状态跟踪（用于防抖）<br>unsigned long lastPressTime &#x3D; 0;<br>const uint16_t DEBOUNCE_DELAY &#x3D; 600; &#x2F;&#x2F; 防抖延迟(ms)</p>
<p>&#x2F;&#x2F; 添加全局变量用于息屏控制<br>unsigned long lastActiveTime &#x3D; 0; &#x2F;&#x2F; 最后一次活动时间<br>const unsigned long SCREEN_OFF_DELAY &#x3D; 10 * 60 * 1000; &#x2F;&#x2F; 10分钟（毫秒）<br>bool screenOn &#x3D; true; &#x2F;&#x2F; 屏幕状态<br>SongInfo lastInfo;</p>
<p>&#x2F;&#x2F; 发送命令到串口<br>void sendCommand(Command cmd, int dataLength &#x3D; 0, byte* data &#x3D; nullptr) {<br>  switch(cmd) {<br>    case CMD_PLAY:<br>      Serial.println(“PLAY”);  &#x2F;&#x2F; 使用println自动添加\r\n</p>
<pre><code>  break;
case CMD_PAUSE:
  Serial.println(&quot;PAUSE&quot;);

  break;
case CMD_NEXT:
  Serial.println(&quot;NEXT&quot;);

  break;
case CMD_PREV:
  Serial.println(&quot;PREV&quot;);

  break;
case CMD_PLAY_SONG:
  if(dataLength &gt; 0 &amp;&amp; data != nullptr) &#123;
    Serial.print(&quot;SONG:&quot;);
    Serial.println(data[0]);  // 使用println

  &#125;
  break;
</code></pre>
<p>  }</p>
<p>  delay(20); &#x2F;&#x2F; 给 Linux 足够时间接收<br>  Serial.flush();<br>}</p>
<p>&#x2F;&#x2F; 关闭屏幕<br>void turnOffScreen() {<br>  u8g2.clearBuffer();<br>  u8g2.sendBuffer();<br>  screenOn &#x3D; false;<br>}</p>
<p>&#x2F;&#x2F; 打开屏幕<br>void turnOnScreen() {<br>  screenOn &#x3D; true;<br>  &#x2F;&#x2F; 屏幕内容会在下次updateDisplay调用时刷新<br>}</p>
<p>&#x2F;&#x2F; 修改按键处理函数，返回是否有按键按下<br>bool handleButtonPress() {<br>  &#x2F;&#x2F; 防抖检查<br>  static unsigned long lastPressTime &#x3D; 0;<br>  if (millis() - lastPressTime &lt; DEBOUNCE_DELAY) return false;</p>
<p>  bool buttonPressed &#x3D; false;</p>
<p>  &#x2F;&#x2F; 检测按键按下（低电平触发）<br>  if (digitalRead(BUTTON_PLAY) &#x3D;&#x3D; LOW) {<br>    sendCommand(CMD_PLAY);<br>    lastPressTime &#x3D; millis();<br>    buttonPressed &#x3D; true;<br>  }<br>  else if (digitalRead(BUTTON_PAUSE) &#x3D;&#x3D; LOW) {<br>    sendCommand(CMD_PAUSE);<br>    lastPressTime &#x3D; millis();<br>    buttonPressed &#x3D; true;<br>  }<br>  else if (digitalRead(BUTTON_NEXT) &#x3D;&#x3D; LOW) {<br>    sendCommand(CMD_NEXT);<br>    lastPressTime &#x3D; millis();<br>    buttonPressed &#x3D; true;<br>  }<br>  else if (digitalRead(BUTTON_PREV) &#x3D;&#x3D; LOW) {<br>    sendCommand(CMD_PREV);<br>    lastPressTime &#x3D; millis();<br>    buttonPressed &#x3D; true;<br>  }<br>  #if GATEWAY<br>  else if (digitalRead(BUTTON_SONG1) &#x3D;&#x3D; LOW) {<br>    byte songNum &#x3D; 1;<br>    sendCommand(CMD_PLAY_SONG, 1, &amp;songNum);<br>    lastPressTime &#x3D; millis();<br>    buttonPressed &#x3D; true;<br>  }<br>  else if (digitalRead(BUTTON_SONG2) &#x3D;&#x3D; LOW) {<br>    byte songNum &#x3D; 2;<br>    sendCommand(CMD_PLAY_SONG, 1, &amp;songNum);<br>    lastPressTime &#x3D; millis();<br>    buttonPressed &#x3D; true;<br>  }<br>  else if (digitalRead(BUTTON_SONG3) &#x3D;&#x3D; LOW) {<br>    byte songNum &#x3D; 3;<br>    sendCommand(CMD_PLAY_SONG, 1, &amp;songNum);<br>    lastPressTime &#x3D; millis();<br>    buttonPressed &#x3D; true;<br>  }<br>  else if (digitalRead(BUTTON_SONG4) &#x3D;&#x3D; LOW) {<br>    byte songNum &#x3D; 4;<br>    sendCommand(CMD_PLAY_SONG, 1, &amp;songNum);<br>    lastPressTime &#x3D; millis();<br>    buttonPressed &#x3D; true;<br>  }<br>  #endif</p>
<p>  if (buttonPressed) {<br>    if (!screenOn) turnOnScreen();<br>    lastActiveTime &#x3D; millis();<br>  }</p>
<p>  return buttonPressed;<br>}</p>
<p>void setup() {</p>
<p>  pinMode(BUTTON_PAUSE, INPUT_PULLUP);<br>  pinMode(BUTTON_PLAY, INPUT_PULLUP);<br>  pinMode(BUTTON_NEXT, INPUT_PULLUP);<br>  pinMode(BUTTON_PREV, INPUT_PULLUP);</p>
<p>  #if  GATEWAY</p>
<p>  pinMode(BUTTON_SONG1, INPUT_PULLUP);<br>  pinMode(BUTTON_SONG2, INPUT_PULLUP);<br>  pinMode(BUTTON_SONG3, INPUT_PULLUP);<br>  pinMode(BUTTON_SONG4, INPUT_PULLUP);</p>
<p>  #endif</p>
<p>  Serial.begin (115200);</p>
<p>  &#x2F;&#x2F;Mount FS</p>
<p>  Serial.println(“Mounting FS…”);<br>   if (!SPIFFS.begin(true)) {<br>    &#x2F;&#x2F;Serial.println(“SPIFFS mount failed”);<br>    return;<br>  }</p>
<p>  u8g2.begin();  &#x2F;&#x2F; 初始化屏幕<br>  u8g2.clearBuffer(); &#x2F;&#x2F; 清空缓冲区<br>  u8g2.setFont(u8g2_font_wqy12_t_gb2312);<br>  u8g2.setContrast(0); &#x2F;&#x2F; 设置对比度 (0-255)</p>
<p>  &#x2F;&#x2F; 显示初始化界面<br>  u8g2.drawUTF8(0, 15, “等待 Volumio 数据…”);<br>  u8g2.sendBuffer();</p>
<p>  lastActiveTime &#x3D; millis();</p>
<p>}</p>
<p>SongInfo parseJsonFull(String jsonStr) {<br>  SongInfo info;<br>  DynamicJsonDocument doc(2048);<br>  DeserializationError error &#x3D; deserializeJson(doc, jsonStr);</p>
<p>  if (error) {<br>    &#x2F;&#x2F; 打印错误信息<br>    info.title &#x3D; “数据错误”;<br>    info.prevSong &#x3D; “未知”;<br>    info.nextSong &#x3D; “未知”;<br>    info.duration &#x3D; 1;<br>    info.seek &#x3D; 0;<br>    info.status &#x3D; “stop”;<br>    return info;<br>  }</p>
<p>  info.title &#x3D; doc[“title”] | “无歌曲”;<br>  info.prevSong &#x3D; doc[“prevSong”] | “无”;<br>  info.nextSong &#x3D; doc[“nextSong”] | “无”;<br>  info.status &#x3D; doc[“status”] | “stop”;<br>  info.duration &#x3D; doc[“duration”] | 1;<br>  info.seek &#x3D; doc[“seek”] | 0;</p>
<p>  if (info.duration &lt;&#x3D; 0) info.duration &#x3D; 1;<br>  if (info.seek &lt; 0) info.seek &#x3D; 0;<br>  if (info.seek &gt;&#x3D; info.duration) info.seek &#x3D; info.duration - 1;</p>
<p>  return info;<br>}</p>
<p>&#x2F;&#x2F; 解析 JSON 数据<br>SongInfo parseJson(String jsonStr) {<br>  SongInfo info;<br>  DynamicJsonDocument doc(2048);<br>  DeserializationError error &#x3D; deserializeJson(doc, jsonStr);</p>
<p>  if (error) {<br>    info.title &#x3D; “数据错误”;<br>    info.prevSong &#x3D; “未知”;<br>    info.nextSong &#x3D; “未知”;<br>    return info;<br>  }</p>
<p>  &#x2F;&#x2F; 安全提取字段 (带默认值)<br>  info.title &#x3D; doc[“title”] | “无歌曲”;<br>  info.prevSong &#x3D; doc[“prevSong”] | “无”;<br>  info.nextSong &#x3D; doc[“nextSong”] | “无”;<br>  info.status &#x3D; doc[“status”] | “stop”;<br>  info.duration &#x3D; doc[“duration”] | 1;  &#x2F;&#x2F; 防止除零<br>  info.seek &#x3D; doc[“seek”] | 0;</p>
<p>  &#x2F;&#x2F; 强制数据有效性<br>  if (info.duration &lt;&#x3D; 0) info.duration &#x3D; 1;<br>  if (info.seek &lt; 0) info.seek &#x3D; 0;<br>  if (info.seek &gt;&#x3D; info.duration) info.seek &#x3D; info.duration - 1;</p>
<p>  return info;<br>}</p>
<p>&#x2F;&#x2F; 安全映射函数 (防止 min&#x3D;&#x3D;max 崩溃)<br>int mapSafe(int value, int in_min, int in_max, int out_min, int out_max) {<br>  if (in_min &#x3D;&#x3D; in_max) return out_min;<br>  value &#x3D; constrain(value, in_min, in_max);<br>  return (value - in_min) * (out_max - out_min) &#x2F; (in_max - in_min) + out_min;<br>}</p>
<p>&#x2F;&#x2F; 更新 OLED 显示 (完整歌曲名，无按键提示)<br>void updateDisplay(const SongInfo &amp;info) {<br>  &#x2F;&#x2F; 如果屏幕是关闭状态，直接返回<br>  if (!screenOn) {<br>    return;<br>  }</p>
<p>  u8g2.clearBuffer();</p>
<p>  &#x2F;&#x2F; 1. 显示当前歌曲标题 (使用中文字体，第一行)<br>  u8g2.setFont(u8g2_font_wqy12_t_gb2312);<br>  String displayTitle &#x3D; info.title;<br>  &#x2F;&#x2F; 不进行截断，直接显示完整歌名<br>  u8g2.drawUTF8(0, 12, displayTitle.c_str());</p>
<p>  &#x2F;&#x2F; 2. 显示上一首歌曲 (使用中文字体，第二行)<br>  String prevSong &#x3D; “前:” + info.prevSong;<br>  &#x2F;&#x2F; 不进行截断，直接显示完整歌名<br>  u8g2.drawUTF8(0, 24, prevSong.c_str());</p>
<p>  &#x2F;&#x2F; 3. 显示下一首歌曲 (使用中文字体，第三行)<br>  String nextSong &#x3D; “后:” + info.nextSong;<br>  &#x2F;&#x2F; 不进行截断，直接显示完整歌名<br>  u8g2.drawUTF8(0, 36, nextSong.c_str());</p>
<p>  &#x2F;&#x2F; 4. 绘制进度条<br>  int progressWidth &#x3D; mapSafe(info.seek, 0, info.duration, 0, 128);<br>  u8g2.drawFrame(0, 44, 128, 6);<br>  u8g2.drawBox(0, 44, progressWidth, 6);</p>
<p>  &#x2F;&#x2F; 5. 显示时间和状态<br>  u8g2.setFont(u8g2_font_5x7_tf); &#x2F;&#x2F; 使用5x7小字体<br>  char timeStr[16];<br>  snprintf(timeStr, sizeof(timeStr), “%02d:%02d&#x2F;%02d:%02d”,<br>           info.seek &#x2F; 60, info.seek % 60,<br>           info.duration &#x2F; 60, info.duration % 60);<br>  u8g2.drawStr(0, 58, timeStr);</p>
<p>  &#x2F;&#x2F; 播放状态 (使用中文字体)<br>  u8g2.setFont(u8g2_font_wqy12_t_gb2312);<br>  String statusText &#x3D; (info.status &#x3D;&#x3D; “play”) ? “播放” : “暂停”;<br>  u8g2.drawUTF8(80, 58, statusText.c_str());</p>
<p>  u8g2.sendBuffer();<br>}</p>
<p>&#x2F;&#x2F; 仅更新进度条和当前播放时间<br>void updateSeekOnly(int seek, int duration) {<br>  &#x2F;&#x2F; 绘制进度条<br>  int progressWidth &#x3D; mapSafe(seek, 0, duration, 0, 128);<br>  u8g2.drawFrame(0, 44, 128, 6);<br>  u8g2.drawBox(0, 44, progressWidth, 6);</p>
<p>  &#x2F;&#x2F; 更新时间显示<br>  u8g2.setFont(u8g2_font_5x7_tf); &#x2F;&#x2F; 小字体<br>  char timeStr[16];<br>  snprintf(timeStr, sizeof(timeStr), “%02d:%02d&#x2F;%02d:%02d”,<br>           seek &#x2F; 60, seek % 60,<br>           duration &#x2F; 60, duration % 60);<br>  u8g2.drawStr(0, 58, timeStr);</p>
<p>  &#x2F;&#x2F; 保留播放状态显示<br>  u8g2.setFont(u8g2_font_wqy12_t_gb2312);<br>  String statusText &#x3D; (lastInfo.status &#x3D;&#x3D; “play”) ? “播放” : “暂停”;<br>  u8g2.drawUTF8(80, 58, statusText.c_str());</p>
<p>  u8g2.sendBuffer();<br>}</p>
<p>&#x2F;&#x2F; 修改检查息屏的函数<br>void checkScreenTimeout() {<br>  unsigned long currentTime &#x3D; millis();</p>
<p>  &#x2F;&#x2F; 如果正在播放，保持屏幕开启<br>  if (lastInfo.status &#x3D;&#x3D; “play”) {<br>    if (!screenOn) turnOnScreen();<br>    return;<br>  }</p>
<p>  &#x2F;&#x2F; 如果是暂停状态，检查是否超时<br>  if (lastInfo.status &#x3D;&#x3D; “pause” || lastInfo.status &#x3D;&#x3D; “stop”) {<br>    if (screenOn &amp;&amp; (currentTime - lastActiveTime &gt; SCREEN_OFF_DELAY)) {<br>      turnOffScreen();<br>    }<br>  }<br>}</p>
<p>&#x2F;&#x2F; 修改loop函数中的数据处理逻辑<br>void loop() {<br>  if (Serial.available()) {<br>    String line &#x3D; Serial.readStringUntil(‘\n’);<br>    line.trim();<br>    if (line.length() &gt; 0) {<br>      DynamicJsonDocument doc(2048);<br>      DeserializationError err &#x3D; deserializeJson(doc, line);</p>
<pre><code>  if (!err &amp;&amp; doc.containsKey(&quot;seek&quot;) &amp;&amp; !doc.containsKey(&quot;title&quot;)) &#123;
    // 进度更新
    int seek = doc[&quot;seek&quot;];
    updateSeekOnly(seek, lastInfo.duration);
    lastInfo.seek = seek;
  &#125; else &#123;
    // 完整状态更新
    SongInfo newInfo = parseJsonFull(line);
    
    // 检查状态是否有重要变化
    bool significantChange = (newInfo.title != lastInfo.title || 
                             newInfo.status != lastInfo.status);
    
    lastInfo = newInfo;
    updateDisplay(lastInfo);
    
    // 只有重要变化才重置息屏计时器
    if (significantChange) &#123;
      lastActiveTime = millis();
    &#125;
  &#125;
&#125;
</code></pre>
<p>  }</p>
<p>  &#x2F;&#x2F; 按键操作重置息屏计时器<br>  if (handleButtonPress()) {<br>    lastActiveTime &#x3D; millis();<br>  }</p>
<p>  checkScreenTimeout();<br>  delay(50);<br>}</p>
<p>‘’’</p>

      
    </div>
    
      <div class="full-width auto-padding tags">
        
          <a href="/tags/linux/" rel="nofollow"><i class="fas fa-hashtag fa-fw"></i>linux</a>
        
      </div>
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2025/10/31/volumio-q7/">
      volumio运行在Q7 电视盒上
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    <a href="https://pazulin.github.io" rel="nofollow">
      
        <i class="fas fa-user" aria-hidden="true"></i>
      
      <p>井蛙</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2025-10-31</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/linux/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>linux</p>
    </a>
  </div>


          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <p>Q7 能跑一个volumio 2.8的固件<br>地址在<br>2.6<br><a href="http://updates.volumio.org/vim1/volumio/2.603/volumio-2.603-2019-09-03-vim1.img.zip">http://updates.volumio.org/vim1/volumio/2.603/volumio-2.603-2019-09-03-vim1.img.zip</a></p>
<p>2.8<br><a href="http://updates.volumio.org/aml9xxxarmv7/volumio/2.857/volumio-2.857-2020-12-11-aml9xxxarmv7.img.zip">http://updates.volumio.org/aml9xxxarmv7/volumio/2.857/volumio-2.857-2020-12-11-aml9xxxarmv7.img.zip</a></p>
<p>我运行是下面2.8这个版本</p>
<p>dtb 文件改一下, 改成一个dtb.img,这个文件我忘记是从哪里复制的了</p>
<p>apt 的源 要改一下<br>deb <a href="http://archive.debian.org/debian">http://archive.debian.org/debian</a> jessie main contrib non-free<br>deb <a href="http://archive.debian.org/debian-security">http://archive.debian.org/debian-security</a> jessie&#x2F;updates main contrib non-free</p>
<p>下面来自恩山</p>
<p>PS 哪位大大 有Volumio docker ARM 版本的<br>hub.docker.com上面找到 只有 X86 版本的<br>N1用不了</p>
<p>补充一下，一、初绍化volumio<br>  有朋友反馈无法使用以太网，需要替换DTB.img<br>  我用的是无线，所以没有去试，那们朋友如果有回复需要替换那个文件 我再更新<br>  42# @LXPCWL 朋友已经解决了这个问题<br>无线初始化大概说一下，论坛里面应该有比较详细的<br>1、写入U盘 后，启动（这个版本可以写入emmc）<br>2、电脑（我是用笔记本，手机也可以）搜索到一个叫 volumio  SSID<br>3、连接上 查看一下获取到IP地址是不是 192.168.211.X<br>4、访问<a href="http://192.168.211.1:3000/">http://192.168.211.1:3000</a><br>5、按照提示设置一下 volumio连接进你的家庭WIFI</p>
<p>二、打开ssh 访问 <a href="http://volumioip:3000/dev">http://volumioIP:3000/dev</a><br>ssh enable然后就可以 ssh登录volumio 了<br>用户名密码都是 volumio<br>root 的密码也是 volumio</p>

      
    </div>
    
      <div class="full-width auto-padding tags">
        
          <a href="/tags/linux/" rel="nofollow"><i class="fas fa-hashtag fa-fw"></i>linux</a>
        
      </div>
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2025/10/10/iho-3300ad/">
      IHO-3300AD高安 刷armbian
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    <a href="https://pazulin.github.io" rel="nofollow">
      
        <i class="fas fa-user" aria-hidden="true"></i>
      
      <p>井蛙</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2025-10-10</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/linux/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>linux</p>
    </a>
  </div>


          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <p>图便宜15元一个 ,买了5个 . 谁知道是高安版, 而且没有wifi . 刷机过程也是折腾</p>
<ol>
<li><p>要下载一个兼容的安卓镜像, 幸运的找到一个 “小黄IHO3300AD(905)四川高安最新没有无线线刷2261.img”,如果不是,卡在1%不动</p>
</li>
<li><p>usb 公头用软件烧入, 这个步骤很奇怪, 有时候这个usb口不行,换下一个usb口就可以, 可能是我笔记本usb hub 问题?</p>
</li>
<li><p>焊好TTL先, 其中有2个跳线断开了, 2R1 2R24 短接, 恢复ttl功能.</p>
</li>
<li><p>启动进入安卓系统<br>2r1 2r24 短接 恢复ttl功能<br>ttl 终端 密码<br>sh login：root<br>Password：Ch4008111666</p>
</li>
</ol>
<p>5.烧好一个armbian镜像. 发觉meson-gxl-s905l2-x7-5g.dtb 可用, 修改uEnv.txt 文件,改过来, 然后extlinux 里面 的conf文件也要把bak去掉,变成extlinux.conf,这样就能启动, 不过网卡没用<br>要把u-boot-s905x-s905lb.bin 复制 改名为 u-boot.ext, 这样就能启动了 ,并有网卡.</p>
<ol start="6">
<li><p>插入tf卡,启动安卓, 并进入系统,执行reboot update ,就可以启动armbian</p>
</li>
<li><p>执行armbian-install . 不过安装后没有网卡, 不止什么原因,搞了很久也不想, 折腾到这里结束</p>
</li>
</ol>
<p>Rank0: 1024MB(auto)-2T-18<br>AddrBus test pass!<br>-s<br>Load fip header from eMMC, src: 0x0000c200, des: 0x01400000, size: 0x00004000<br>aml log : R2048 check pass!<br>New fip structure!<br>Load bl30 from eMMC, src: 0x00010200, des: 0x01700000, size: 0x00007600<br>aml log : R2048 check pass!<br>Load bl301 from eMMC, src: 0x00018200, des: 0x01700000, size: 0x00002400<br>aml log : R2048 check pass!<br>Load bl31 from eMMC, src: 0x0001c200, des: 0x01700000, size: 0x00019600<br>aml log : R2048 check pass!<br>Load bl33 from eMMC, src: 0x00038200, des: 0x01700000, size: 0x0007b000<br>aml log : R2048 check pass!<br>NOTICE:  BL3-1: v1.0(debug):521e8c3<br>NOTICE:  BL3-1: Built : 14:22:49, Jun  5 2018<br>NOTICE:  BL31: GXL secure boot!<br>NOTICE:  BL31: BL33 decompress pass<br>[Image: gxl_v1.1.3101-a78fa1e 2018-06-04 16:24:21 huan.biao@droid12]<br>efuse init ops &#x3D; c5<br>efuse init hdcp &#x3D; c, cf9&#x3D;7<br>bl30: check_permit, count is 1<br>bl30: check_permit: ok!<br>chipid: 0 0 7 1c c 0 32 b4 40 a0 0 c5 not ES chip<br>[1.633107 Inits done]<br>INFO:    BL3-1: Initializing runtime services<br>WARNING: No OPTEE provided by BL2 boot loader<br>ERROR:   Error initializing runtime service opteed_fast<br>INFO:    BL3-1: Preparing for EL3 exit to normal world<br>INFO:    BL3-1: Next image address &#x3D; 0x1000000<br>INFO:    BL3-1: Next image spsr &#x3D; 0x3c9</p>
<p>U-Boot 2015.01 (May 25 2021 - 14:13:05), Build: jenkins-SC_IHO-3300AD_2140133-00060-3</p>
<p>DRAM:  1 GiB<br>Relocation Offset is: 36e8c000</p>

      
    </div>
    
      <div class="full-width auto-padding tags">
        
          <a href="/tags/linux/" rel="nofollow"><i class="fas fa-hashtag fa-fw"></i>linux</a>
        
      </div>
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2025/09/21/compile-volumio/">
      编译Volumio
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    <a href="https://pazulin.github.io" rel="nofollow">
      
        <i class="fas fa-user" aria-hidden="true"></i>
      
      <p>井蛙</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2025-09-21</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/linux/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>linux</p>
    </a>
  </div>


          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <p>内存不够, 需要增加swap</p>
<p>sudo fallocate -l 2G &#x2F;swapfile     # 新建 2G 大小的 swap<br>sudo chmod 600 &#x2F;swapfile           # 权限要正确<br>sudo mkswap &#x2F;swapfile              # 格式化成 swap<br>sudo swapon &#x2F;swapfile              # 启用 swap</p>
<p>free -h 查看</p>
<p>开大内存<br>export NODE_OPTIONS&#x3D;”–max-old-space-size&#x3D;1536”</p>
<p>编译时减少进程<br>npm install –unsafe-perm –no-audit –no-fund –maxsockets&#x3D;1 –verbose</p>

      
    </div>
    
      <div class="full-width auto-padding tags">
        
          <a href="/tags/linux/" rel="nofollow"><i class="fas fa-hashtag fa-fw"></i>linux</a>
        
      </div>
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2024/12/13/ch347tdriver/">
      关于在Q7的armbian里面编译8189fs驱动
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    <a href="https://pazulin.github.io" rel="nofollow">
      
        <i class="fas fa-user" aria-hidden="true"></i>
      
      <p>井蛙</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2024-12-13</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/linux/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>linux</p>
    </a>
  </div>


          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <p>新版的armbian  在<a href="https://github.com/ophub/amlogic-s9xxx-armbian/releases%E9%87%8C%E9%9D%A2,%E6%AF%94%E6%88%91%E8%87%AA%E5%B7%B1%E5%87%A0%E5%B9%B4%E5%89%8D%E7%BC%96%E8%AF%91%E7%9A%84%E5%A5%BD%E5%A4%9A%E4%BA%86">https://github.com/ophub/amlogic-s9xxx-armbian/releases里面,比我自己几年前编译的好多了</a>, 但是wifi还是没有装驱动,可以手动编译一个</p>
<p>数码视讯的Q7的8189fs 驱动 ,注意, 必须要这个分支</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git clone -b rtl8189fs  https://github.com/jwrdegoede/rtl8189ES_linux.git</span><br><span class="line"></span><br><span class="line">然后就是编译</span><br><span class="line">make -j4 ARCH=arm64 KSRC=/usr/lib/modules/$(uname -r)/build</span><br><span class="line">sudo cp 8189fs.ko /usr/lib/modules/$(uname -r)/kernel/drivers/net/wireless/realtek/</span><br><span class="line">sudo depmod -a</span><br><span class="line">sudo modprobe 8189fs</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>
    
      <div class="full-width auto-padding tags">
        
          <a href="/tags/linux/" rel="nofollow"><i class="fas fa-hashtag fa-fw"></i>linux</a>
        
      </div>
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2024/12/09/youyou-gpt/">
      chatgpt智能音箱制作
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    <a href="https://pazulin.github.io" rel="nofollow">
      
        <i class="fas fa-user" aria-hidden="true"></i>
      
      <p>井蛙</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2024-12-09</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/linux/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>linux</p>
    </a>
  </div>


          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <p>我这个armbian版本的内核比较新.6.1版本, 4.x版本也试过,没问题</p>
<p>先安装必要的包</p>
<p>如果venv没有,先安装,我的python是3.12 , 根据你版本安装</p>
<p>安装下面的包<br>apt update<br>apt install python3.12-venv<br>apt install python3.12-dev<br>apt install portaudio19-dev</p>
<p>创建虚拟环境<br>python3 -m venv env<br>source env&#x2F;bin&#x2F;activate</p>
<p>安装包<br>pip3 install pvporcupine<br>pip3 install wheel<br>pip3 install pyaudio<br>pip3 install requests<br>pip3 install websocket-client<br>pip3 install openai</p>
<p>因为我这个电视盒原来有个音频设备, 现在修改第二个声卡为缺省声卡, 就是用usb声卡作为缺省声卡</p>
<p>编辑这个文件, 如果没有创建一个<br>&#x2F;etc&#x2F;asound.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">defaults.pcm.card 1</span><br><span class="line">defaults.pcm.device 0</span><br><span class="line">defaults.ctl.card 1</span><br></pre></td></tr></table></figure>

<p>调整声音大小用<br>alsamixer<br>打开这个程序可以看到usb声卡名称, 就说明上面设置对了</p>
<p>安装一个可以用python i2c 驱动一个显示屏的库<br>pip3 install luma.oled</p>
<p>前提是用一个CH347T做个一个usb 转i2c 的板<br>这个板的驱动可以github上面下载编译安装.</p>

      
    </div>
    
      <div class="full-width auto-padding tags">
        
          <a href="/tags/linux/" rel="nofollow"><i class="fas fa-hashtag fa-fw"></i>linux</a>
        
      </div>
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2024/12/09/clash/">
      Clash配置和docker使用备忘
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    <a href="https://pazulin.github.io" rel="nofollow">
      
        <i class="fas fa-user" aria-hidden="true"></i>
      
      <p>井蛙</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2024-12-09</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/linux/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>linux</p>
    </a>
  </div>


          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <h1 id="linux下面设置环境变量"><a href="#linux下面设置环境变量" class="headerlink" title="linux下面设置环境变量"></a>linux下面设置环境变量</h1><p>包括在windows下面的bash等环境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export https_proxy=http://127.0.0.1:7890 http_proxy=http://127.0.0.1:7890 all_proxy=socks5://127.0.0.1:7890</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h1><p>上网桥接<br>docker network inspect bridge</p>
<p>ip addr show docker0<br>你会看到一个像 172.17.0.1 的地址，这个就是 Docker 容器与主机之间的网桥地址。</p>
<p>步骤 2：运行 Docker 容器并配置代理<br>你需要将容器的网络流量通过 Clash 代理，可以通过以下几种方式实现：</p>
<p>方法 1：在容器运行时设置环境变量<br>运行容器时，通过环境变量设置代理：</p>
<p>bash<br>复制代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export HTTP_PROXY=http://172.17.0.1:7890</span><br><span class="line">export HTTPS_PROXY=http://172.17.0.1:7890</span><br><span class="line">export NO_PROXY=localhost,127.0.0.1</span><br></pre></td></tr></table></figure>
<p>验证网络连接：</p>
<p>测试代理是否生效，例如：</p>
<p>bash<br>复制代码<br>curl <a href="https://www.google.com/">https://www.google.com</a></p>
<ol>
<li>使用 Docker Volumes（卷）<br>Docker 卷允许你将容器的数据保存在主机的文件系统上。即使容器被删除，数据仍然保留在卷中。</li>
</ol>
<p>创建和使用卷：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm -v /path/on/host:/path/in/container node:18 bash</span><br></pre></td></tr></table></figure>
<p>-v &#x2F;path&#x2F;on&#x2F;host:&#x2F;path&#x2F;in&#x2F;container：这将主机的 &#x2F;path&#x2F;on&#x2F;host 目录与容器的 &#x2F;path&#x2F;in&#x2F;container 目录进行挂载。所有写入 &#x2F;path&#x2F;in&#x2F;container 的数据都会存储在主机的 &#x2F;path&#x2F;on&#x2F;host 目录中。<br>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm -v ~/mydata:/data node:18 bash</span><br></pre></td></tr></table></figure>
<p>在容器中对 &#x2F;data 目录进行的所有更改都将保存在主机的 ~&#x2F;mydata 目录中，即使容器停止或删除，数据也不会丢失。</p>

      
    </div>
    
      <div class="full-width auto-padding tags">
        
          <a href="/tags/linux/" rel="nofollow"><i class="fas fa-hashtag fa-fw"></i>linux</a>
        
      </div>
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2021/03/10/s905Lbox/">
      S905盒子安装armbian linux
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    <a href="https://pazulin.github.io" rel="nofollow">
      
        <i class="fas fa-user" aria-hidden="true"></i>
      
      <p>井蛙</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2021-03-10</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/linux/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>linux</p>
    </a>
  </div>


          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <p>过程记下来怕忘记了</p>
<ol start="0">
<li>打开amlogic 烧写软件, 打开Android的镜像.目前比较可行 晶晨S905L-R3300L-V21C-双直播当贝桌面-集成更多遥控适配-解决无线和直播卡顿问题-20180524版.img 这个文件, 打开烧录</li>
<li>靠近网口的usb (ba860盒子) 口连接到pc</li>
<li>短接C125 电容 (ba860盒子)</li>
<li>插入电源,不要松开C125 直到烧写完.</li>
<li>ttl口接到PC,115200, 启动android. </li>
<li>插入我之前烧好了一个不记得什么系统的tf卡.</li>
<li>启动后,输入reboot update.</li>
<li>搞定后,可以换成armbian的系统卡.</li>
</ol>

      
    </div>
    
      <div class="full-width auto-padding tags">
        
          <a href="/tags/linux/" rel="nofollow"><i class="fas fa-hashtag fa-fw"></i>linux</a>
        
      </div>
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2021/03/05/try-med/">
      中医试药体会1
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    <a href="https://pazulin.github.io" rel="nofollow">
      
        <i class="fas fa-user" aria-hidden="true"></i>
      
      <p>井蛙</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2021-03-05</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/%E4%B8%AD%E5%8C%BB/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>中医</p>
    </a>
  </div>


          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <h2 id="下针行间-太冲"><a href="#下针行间-太冲" class="headerlink" title="下针行间,太冲"></a>下针行间,太冲</h2><p>左右脚下针这两个穴位, 左脚下位置对一点, 太冲行针试试,第二脚趾有反应,下针位置片了一点,但是附近都又酸胀感,  右脚下不好,没什么感觉.<br>下完后本来右协有点不舒服, 下完后确实好一点. 第二天, 左甲状腺附近的压痛感也好一些. 右甲状腺附近好一点,但是还是右压痛.</p>
<h2 id="四逆散"><a href="#四逆散" class="headerlink" title="四逆散"></a>四逆散</h2><p>最近天气冷,手脚都冷, 感觉有点冰, 可能各种问题的原因把.  但是想单独试试四逆散, 柴胡白芍枳实甘草各6g.吃完,今天下午,手终于不想之前那么冷.<br>脚穿袜子,鞋 ,可能不是很明显. 但没有脚很暖的感觉. 手确实是暖.<br>另外,右边章门压痛很明显, 今天竟然不怎么压痛.</p>
<h1 id="关于针灸的对侧治疗体会"><a href="#关于针灸的对侧治疗体会" class="headerlink" title="关于针灸的对侧治疗体会"></a>关于针灸的对侧治疗体会</h1><ul>
<li>之前右协不舒服,针行间, 只针行间,左脚就比右脚有感觉.</li>
<li>自己左胸不舒服,发现一直以来右脚的公孙位置就一直会痒,会长湿疹之类的,自己肺总有湿痰.</li>
</ul>

      
    </div>
    
      <div class="full-width auto-padding tags">
        
          <a href="/tags/%E4%B8%AD%E5%8C%BB/" rel="nofollow"><i class="fas fa-hashtag fa-fw"></i>中医</a>
        
      </div>
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2021/02/20/frp/">
      frp 内网穿越
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    <a href="https://pazulin.github.io" rel="nofollow">
      
        <i class="fas fa-user" aria-hidden="true"></i>
      
      <p>井蛙</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2021-02-20</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/linux/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>linux</p>
    </a>
  </div>


          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <p>不废话,直接上流程</p>
<h1 id="服务区端"><a href="#服务区端" class="headerlink" title="服务区端"></a>服务区端</h1><p>mt7621的cpu的一个路由器 ,跑mipsle的程序,</p>
<h1 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h1><p>这个客户端时一个wr703n的路由器, 用来做mqtt server , 跑mips程序,其中把web控制页面透过frp共享出去. 端口为80 .</p>
<p>frpc.ini</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr = xxx.xxx.com</span><br><span class="line">server_port = 7000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># decide if exit program when first login failed, otherwise continuous relogin to frps</span><br><span class="line"># default is true</span><br><span class="line">login_fail_exit = true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># auth token</span><br><span class="line">token = xxxxxxxxxxxxx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#[ssh]</span><br><span class="line">#type = tcp</span><br><span class="line">#local_ip = 127.0.0.1</span><br><span class="line">#local_port = 22</span><br><span class="line">#remote_port = 6000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[tai_web]</span><br><span class="line">type = http</span><br><span class="line">local_port = 80</span><br><span class="line">privilege_mode = true</span><br><span class="line">custom_domains = abc.abc.com </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>custom_domains &#x3D; abc.abc.com  这个域名必须域名解析器加上,让其解析到 服务器ip,或者服务器的域名.</p>
<p>下面自启动进程 </p>
<p>必须先安装 nohup</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install coreutils-nohup</span><br></pre></td></tr></table></figure>

<p>增加下面这个文件</p>
<p>&#x2F;etc&#x2F;init.d&#x2F;frpc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh /etc/rc.common</span><br><span class="line"># Copyright (C) 2006-2011 OpenWrt.org</span><br><span class="line"></span><br><span class="line">START=99</span><br><span class="line"></span><br><span class="line">start() &#123;</span><br><span class="line">        sleep 60; nohup  /root/frp_0.35.1_linux_mips/frpc -c  /root/frp_0.35.1_linux_mips/frpc.ini &gt;/tmp/nohup.out 2&gt;&amp;1 &amp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stop() &#123;</span><br><span class="line">        kill -9 `ps | grep &#x27;/root/frp_0.35.1_linux_mips/frpc&#x27; | grep -v &#x27;grep&#x27; | awk &#x27;&#123;print $1&#125;&#x27;`</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在&#x2F;etc&#x2F;rc.d&#x2F; 增加一个链接文件</p>
<p>ln -s &#x2F;etc&#x2F;init.d&#x2F;frpc &#x2F;etc&#x2F;rc.d&#x2F;S99frpc</p>

      
    </div>
    
      <div class="full-width auto-padding tags">
        
          <a href="/tags/linux/" rel="nofollow"><i class="fas fa-hashtag fa-fw"></i>linux</a>
        
      </div>
    
  </section>
</article>

          </div>
        
      
    
  </section>
  
    
      <br>
      <div class="prev-next">
        <div class="prev-next">
          
          <p class="current">
            1 / 4
          </p>
          
            <a class="next" rel="next" href="/page/2/">
              <section class="post next">
                &nbsp;Next&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i>
              </section>
            </a>
          
        </div>
      </div>

    
    <!-- 根据主题中的设置决定是否在archive中针对摘要部分的MathJax公式加载mathjax.js文件 -->
    
    

  


</div>
<aside class='l_side'>
  
    
    
      
        
          
          
            <section class='widget author'>
  <div class='content material'>
    
      <div class='avatar'>
        <img class='avatar' src='/images/head.jpg'/>
      </div>
    
    
    
      <div class="social-wrapper">
        
          
            <a href="/atom.xml"
              class="social fas fa-rss flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
        
          
            <a href="https://github.com/pazulin"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://music.163.com/"
              class="social fas fa-headphones-alt flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
      </div>
    
  </div>
</section>

          
        
      
        
          
          
            

          
        
      
        
          
          
            <section class='widget grid'>
  
<header class='material'>
  <div><i class="fas fa-map-signs fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;站内导航</div>
  
</header>

  <div class='content material'>
    <ul class="grid navgation">
      
        <li><a class="flat-box" title="/" href="/"
          
          
          id="home">
          
            <i class="fas fa-clock fa-fw" aria-hidden="true"></i>
          
          近期文章
        </a></li>
      
        <li><a class="flat-box" title="/archives/" href="/archives/"
          
            rel="nofollow"
          
          
          id="archives">
          
            <i class="fas fa-archive fa-fw" aria-hidden="true"></i>
          
          文章归档
        </a></li>
      
        <li><a class="flat-box" title="/projects/" href="/projects/"
          
          
          id="projects">
          
            <i class="fas fa-code-branch fa-fw" aria-hidden="true"></i>
          
          开源项目
        </a></li>
      
        <li><a class="flat-box" title="/about/" href="/about/"
          
            rel="nofollow"
          
          
          id="about">
          
            <i class="fas fa-info-circle fa-fw" aria-hidden="true"></i>
          
          关于小站
        </a></li>
      
    </ul>
  </div>
</section>

          
        
      
        
          
          
            
  <section class='widget category'>
    
<header class='material'>
  <div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;Categories</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/categories/"
    title="/categories/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content material'>
      <ul class="entry">
        
          <li><a class="flat-box" title="/categories/AI/" href="/categories/AI/"><div class='name'>AI</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/PC/" href="/categories/PC/"><div class='name'>PC</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/linux/" href="/categories/linux/"><div class='name'>linux</div><div class='badge'>(16)</div></a></li>
        
          <li><a class="flat-box" title="/categories/live/" href="/categories/live/"><div class='name'>live</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/nodemcu/" href="/categories/nodemcu/"><div class='name'>nodemcu</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/openwrt/" href="/categories/openwrt/"><div class='name'>openwrt</div><div class='badge'>(7)</div></a></li>
        
          <li><a class="flat-box" title="/categories/%E4%B8%AD%E5%8C%BB/" href="/categories/%E4%B8%AD%E5%8C%BB/"><div class='name'>中医</div><div class='badge'>(4)</div></a></li>
        
          <li><a class="flat-box" title="/categories/%E5%AF%93%E8%A8%80/" href="/categories/%E5%AF%93%E8%A8%80/"><div class='name'>寓言</div><div class='badge'>(3)</div></a></li>
        
          <li><a class="flat-box" title="/categories/%E6%88%91%E7%9A%84%E4%BD%9C%E5%93%81/" href="/categories/%E6%88%91%E7%9A%84%E4%BD%9C%E5%93%81/"><div class='name'>我的作品</div><div class='badge'>(1)</div></a></li>
        
      </ul>
    </div>
  </section>


          
        
      
        
          
          
            
  <section class='widget tagcloud'>
    
<header class='material'>
  <div><i class="fas fa-fire fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;Hot Tags</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/tags/"
    title="/tags/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content material'>
      <a href="/tags/AI-armbian/" style="font-size: 14px; color: #999">AI armbian</a> <a href="/tags/OrangePi/" style="font-size: 14px; color: #999">OrangePi</a> <a href="/tags/PC/" style="font-size: 14px; color: #999">PC</a> <a href="/tags/linux/" style="font-size: 24px; color: #555">linux</a> <a href="/tags/live/" style="font-size: 14px; color: #999">live</a> <a href="/tags/nodemcu/" style="font-size: 14px; color: #999">nodemcu</a> <a href="/tags/openwrt/" style="font-size: 20.67px; color: #6c6c6c">openwrt</a> <a href="/tags/%E4%B8%AD%E5%8C%BB/" style="font-size: 17.33px; color: #828282">中医</a> <a href="/tags/%E4%B8%AD%E5%8C%BB-%E7%BB%8F%E6%96%B9/" style="font-size: 14px; color: #999">中医 经方</a> <a href="/tags/%E5%AF%93%E8%A8%80/" style="font-size: 17.33px; color: #828282">寓言</a>
    </div>
  </section>


          
        
      
        
          
          
            



          
        
      
    

  
</aside>

<footer id="footer" class="clearfix">
  
  
    <div class="social-wrapper">
      
        
          <a href="/atom.xml"
            class="social fas fa-rss flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
      
        
          <a href="https://github.com/pazulin"
            class="social fab fa-github flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://music.163.com/"
            class="social fas fa-headphones-alt flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
    </div>
  
  <br>
  <div><p>Blog content follows the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) License</a></p>
</div>
  <div>
    Use
    <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename">Material X</a>
    as theme
    
      , 
      total visits
      <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
      times
    
    . 
  </div>
</footer>
<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>

  <script>
    var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
    var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
    var ALGOLIA_API_KEY = "";
    var ALGOLIA_APP_ID = "";
    var ALGOLIA_INDEX_NAME = "";
    var AZURE_SERVICE_NAME = "";
    var AZURE_INDEX_NAME = "";
    var AZURE_QUERY_KEY = "";
    var BAIDU_API_ID = "";
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/"||"/";
    if(!ROOT.endsWith('/'))ROOT += '/';
  </script>

<script src="//instant.page/1.2.2" type="module" integrity="sha384-2xV8M5griQmzyiY3CDqh1dn4z3llDVqZDqzjzcY+jCBCk/a5fXJmuZ/40JJAPeoU"></script>


  <script async src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      const $reveal = $('.reveal');
      if ($reveal.length === 0) return;
      const sr = ScrollReveal({ distance: 0 });
      sr.reveal('.reveal');
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>




  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>
    <script type="text/javascript">
      $(function(){
        if ('.cover') {
          $('.cover').backstretch(
          ["https://img.vim-cn.com/95/3588f724a8ff9af004dda557ab124d3c3bc33f.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        } else {
          $.backstretch(
          ["https://img.vim-cn.com/95/3588f724a8ff9af004dda557ab124d3c3bc33f.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        }
      });
    </script>
  











  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.5/js/app.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.5/js/search.js"></script>





<!-- 复制 -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  let COPY_SUCCESS = "Copied";
  let COPY_FAILURE = "Copy failed";
  /*页面载入完成后，创建复制按钮*/
  !function (e, t, a) {
    /* code */
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '  <i class="fa fa-copy"></i><span>Copy</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });

      clipboard.on('success', function(e) {
        //您可以加入成功提示
        console.info('Action:', e.action);
        console.info('Text:', e.text);
        console.info('Trigger:', e.trigger);
        success_prompt(COPY_SUCCESS);
        e.clearSelection();
      });
      clipboard.on('error', function(e) {
        //您可以加入失败提示
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        fail_prompt(COPY_FAILURE);
      });
    }
    initCopyCode();

  }(window, document);

  /**
   * 弹出式提示框，默认1.5秒自动消失
   * @param message 提示信息
   * @param style 提示样式，有alert-success、alert-danger、alert-warning、alert-info
   * @param time 消失时间
   */
  var prompt = function (message, style, time)
  {
      style = (style === undefined) ? 'alert-success' : style;
      time = (time === undefined) ? 1500 : time*1000;
      $('<div>')
          .appendTo('body')
          .addClass('alert ' + style)
          .html(message)
          .show()
          .delay(time)
          .fadeOut();
  };

  // 成功提示
  var success_prompt = function(message, time)
  {
      prompt(message, 'alert-success', time);
  };

  // 失败提示
  var fail_prompt = function(message, time)
  {
      prompt(message, 'alert-danger', time);
  };

  // 提醒
  var warning_prompt = function(message, time)
  {
      prompt(message, 'alert-warning', time);
  };

  // 信息提示
  var info_prompt = function(message, time)
  {
      prompt(message, 'alert-info', time);
  };

</script>


<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>





  <script>setLoadingBarProgress(100);</script>
</body>
</html>
